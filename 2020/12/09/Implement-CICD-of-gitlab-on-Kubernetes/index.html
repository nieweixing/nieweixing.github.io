<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="聂伟星个人技术博客"><meta name="keyword" content="聂伟星，博客"><link rel="shortcut icon" href="/img/ironman-draw.png"><script async defer="defer" src="https://buttons.github.io/buttons.js"></script><title>Kubernetes上实现gitlab的CICD - 聂伟星个人技术博客</title><link rel="canonical" href="https://www.niewx.cn/2020/12/09/Implement-CICD-of-gitlab-on-Kubernetes/"><link rel="stylesheet" href="../../../../css/bootstrap.min.css"><link rel="stylesheet" href="../../../../css/dusign-light.css"><link rel="stylesheet" href="../../../../css/dusign-common-light.css"><link rel="stylesheet" href="../../../../css/font-awesome.css"><link rel="stylesheet" href="../../../../css/toc.css"><link rel="stylesheet" href="../../../../css/highlight.css"><link rel="stylesheet" href="../../../../css/widget.css"><link rel="stylesheet" href="../../../../css/rocket.css"><link rel="stylesheet" href="../../../../css/signature.css"><link rel="stylesheet" href="../../../../css/fonts.googleapis.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="../../../../css/photography.css"><script></script><meta name="generator" content="Hexo 4.2.1"></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(snail-bg.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a> <a class="tag" href="/tags/#TKE" title="TKE">TKE</a> <a class="tag" href="/tags/#Devops" title="Devops">Devops</a></div><h1>Kubernetes上实现gitlab的CICD</h1><h2 class="subheading"></h2><span class="meta">Posted by VashonNie on 2020-12-09</span><div class="blank_box"></div><span class="meta">Words <span class="post-count">4.2k</span> and Reading Time <span class="post-count">22</span> Minutes</span><div class="blank_box"></div><span class="meta">Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times</span></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(/img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">聂伟星</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/categories/">Categories</a></li><li><a href="/photography/">Photography</a></li><li><a href="/archive/">Archives</a></li><li><a href="/tags/">Tags</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">Chinese Blog</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><p>本次我们来讲解下如何在k8s上搭建gitlab，并且通过gitlab内Pipeline的ci/cd将代码部署到k8s集群内。</p><p>本次k8s环境基于tke托管集群1.18进行测试，镜像仓库使用的是腾讯云的ccr仓库。</p><h1 id="搭建gitlab"><a href="#搭建gitlab" class="headerlink" title="搭建gitlab"></a>搭建gitlab</h1><p>部署gitla需要部署三个服务，分别是redis、postgresql、gitlab这三个服务，下面我们来讲解具体部署及部署yaml文件</p><p>我们先创建一个gitlab的命名空间，后续部署的所有服务都在这个命名空间下</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubectl create ns gitlab</span></span><br></pre></td></tr></table></figure><h2 id="redis部署"><a href="#redis部署" class="headerlink" title="redis部署"></a>redis部署</h2><p>redis服务是提供给Gitlab服务使用，并不需要暴露在集群外部，因此我们在gitlab&lt;-&gt;redis之间调用的时候，采用内部通信的方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">sameersbn/redis</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/redis</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">redis-cli</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ping</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">redis-cli</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ping</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure><h2 id="postgresql部署"><a href="#postgresql部署" class="headerlink" title="postgresql部署"></a>postgresql部署</h2><p>postgresql部署主要存储gitlab的数据使用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">sameersbn/postgresql:10</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gitlab</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">passw0rd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gitlab_production</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_EXTENSION</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">pg_trgm</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/postgresql</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">pg_isready</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-U</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">pg_isready</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-h</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-U</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">gitlab-postgresql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgresql</span></span><br></pre></td></tr></table></figure><h2 id="gitlab部署"><a href="#gitlab部署" class="headerlink" title="gitlab部署"></a>gitlab部署</h2><p>gitlab服务的部署就相对复杂一些，要添加正确的redis和postgresql的链接信息，同时为了在集群外部访问gitlab,我们需要用treafik给gitlab配置一个ingress,所以最后的时候我们需要给gitlab的服务分配一个测试域名，我们这里的域名是gitlab.k8s.niewx.cn，treafik的搭建可以参考我之前的文章。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">sameersbn/gitlab:11.8.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_TIMEZONE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Beijing</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_SECRETS_DB_KEY_BASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">long-and-random-alpha-numeric-string</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_SECRETS_SECRET_KEY_BASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">long-and-random-alpha-numeric-string</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_SECRETS_OTP_KEY_BASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">long-and-random-alpha-numeric-string</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">admin123456</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_ROOT_EMAIL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">nwx_qdlg@163.com</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gitlab.k8s.niewx.cn</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"80"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_SSH_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"30022"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_NOTIFY_ON_BROKEN_BUILDS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_NOTIFY_PUSHER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"false"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_BACKUP_SCHEDULE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">daily</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GITLAB_BACKUP_TIME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">01</span><span class="string">:00</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_TYPE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">postgresql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"5432"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gitlab</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">passw0rd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gitlab_production</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">redis</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"6379"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/home/git/data</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">180</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">gitlab</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">ssh</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30022</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-webui</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`gitlab.k8s.niewx.cn`)</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h2 id="验证登录gitlab"><a href="#验证登录gitlab" class="headerlink" title="验证登录gitlab"></a>验证登录gitlab</h2><p>在浏览器输入<a href="http://gitlab.k8s.niewx.cn/，然后输入之前在gitlab中配置的账号密码能成功登录即部署成功" target="_blank" rel="noopener">http://gitlab.k8s.niewx.cn/，然后输入之前在gitlab中配置的账号密码能成功登录即部署成功</a></p><p><img src="1.png" alt="upload-image"></p><p><img src="2.png" alt="upload-image"></p><h1 id="配置gitlab-runner"><a href="#配置gitlab-runner" class="headerlink" title="配置gitlab-runner"></a>配置gitlab-runner</h1><p>我们可以部署全局的runner进行使用，也可以单独给某个项目部署runner</p><h2 id="部署全局的runner进行使用"><a href="#部署全局的runner进行使用" class="headerlink" title="部署全局的runner进行使用"></a>部署全局的runner进行使用</h2><p>首先声明一个Configmap gitlab-runner.configmap.yaml来为Gitlab Runner提供需要的环境变量以及一些资源约束信息</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line"><span class="symbol">  REGISTER_NON_INTERACTIVE:</span> <span class="string">"true"</span></span><br><span class="line"><span class="symbol">  REGISTER_LOCKED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="symbol">  METRICS_SERVER:</span> <span class="string">"0.0.0.0:9100"</span></span><br><span class="line"><span class="symbol">  CI_SERVER_URL:</span> <span class="string">"http://gitlab.gitlab.svc.cluster.local/ci"</span> <span class="meta"># k8s内gitlab服务的通信地址格式:svc.namespace.svc.cluster.local, 同时加上/ci这个prefix，这里也可以使用外网访问地址</span></span><br><span class="line"><span class="symbol">  RUNNER_REQUEST_CONCURRENCY:</span> <span class="string">"4"</span></span><br><span class="line"><span class="symbol">  RUNNER_EXECUTOR:</span> <span class="string">"kubernetes"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_NAMESPACE:</span> <span class="string">"gitlab"</span> <span class="meta"># 服务运行的namespace</span></span><br><span class="line"><span class="symbol">  KUBERNETES_PRIVILEGED:</span> <span class="string">"true"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_CPU_LIMIT:</span> <span class="string">"1"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_MEMORY_LIMIT:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_SERVICE_CPU_LIMIT:</span> <span class="string">"1"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_SERVICE_MEMORY_LIMIT:</span> <span class="string">"1Gi"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_HELPER_CPU_LIMIT:</span> <span class="string">"500m"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_HELPER_MEMORY_LIMIT:</span> <span class="string">"100Mi"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_PULL_POLICY:</span> <span class="string">"if-not-present"</span> <span class="meta"># image的拉取策略</span></span><br><span class="line"><span class="symbol">  KUBERNETES_TERMINATIONGRACEPERIODSECONDS:</span> <span class="string">"10"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_POLL_INTERVAL:</span> <span class="string">"5"</span></span><br><span class="line"><span class="symbol">  KUBERNETES_POLL_TIMEOUT:</span> <span class="string">"360"</span></span><br><span class="line"><span class="symbol">kind:</span> ConfigMap</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> gitlab-ci-runner</span><br><span class="line"><span class="symbol">  name:</span> gitlab-ci-runner-cm</span><br><span class="line"><span class="symbol">  namespace:</span> gitlab</span><br></pre></td></tr></table></figure><p>同样的，还需要准备一个Configmapgitlab-ci-runner-scripts.configmap.yml存储清理未被正常调度的Gitlab Runner的Pod. 正常来说，Gitlab runner在完成自己的使命之后，Kubernetes就会发送一个TERM signal信号用于正常的注销Gitlab runner, 所以那些被强制终止的Pod是不会自动的被清理的，而这个脚本就是完成这部分Pod的清理工作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  run.sh: |</span><br><span class="line">    <span class="comment">#!/bin/bash</span></span><br><span class="line">    <span class="function"><span class="title">unregister</span></span>() &#123;</span><br><span class="line">        <span class="built_in">kill</span> %1</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Unregistering runner <span class="variable">$&#123;RUNNER_NAME&#125;</span> ..."</span></span><br><span class="line">        /usr/bin/gitlab-ci-multi-runner unregister -t <span class="string">"<span class="variable">$(/usr/bin/gitlab-ci-multi-runner list 2&gt;&amp;1 | tail -n1 | awk '&#123;print $4&#125;' | cut -d'=' -f2)</span>"</span> -n <span class="variable">$&#123;RUNNER_NAME&#125;</span></span><br><span class="line">        <span class="built_in">exit</span> $?</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">trap</span> <span class="string">'unregister'</span> EXIT HUP INT QUIT PIPE TERM</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Registering runner <span class="variable">$&#123;RUNNER_NAME&#125;</span> ..."</span></span><br><span class="line">    /usr/bin/gitlab-ci-multi-runner register -r <span class="variable">$&#123;GITLAB_CI_TOKEN&#125;</span></span><br><span class="line">    sed -i <span class="string">'s/^concurrent.*/concurrent = '</span><span class="string">"<span class="variable">$&#123;RUNNER_REQUEST_CONCURRENCY&#125;</span>"</span><span class="string">'/'</span> /home/gitlab-runner/.gitlab-runner/config.toml</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Starting runner <span class="variable">$&#123;RUNNER_NAME&#125;</span> ..."</span></span><br><span class="line">    /usr/bin/gitlab-ci-multi-runner run -n <span class="variable">$&#123;RUNNER_NAME&#125;</span> &amp;</span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: gitlab-ci-runner</span><br><span class="line">  name: gitlab-ci-runner-scripts</span><br><span class="line">  namespace: gitlab</span><br></pre></td></tr></table></figure><p>我们需要创建一个Secretgitlab-ci-token-secret.yaml来存储Gitlab Runner的Token.以便上面的脚本能正常的运行，在secret内需要存放base64加密后的字符串。<br>我们还需要获取下全局token，获取方式如下</p><p><img src="3.png" alt="upload-image"></p><p><img src="4.png" alt="upload-image"></p><p>获取后对token进行base64编码</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo H4EC7Q12GsCVsDU1jM-y <span class="string">| base64</span></span><br></pre></td></tr></table></figure><p>然后配置到secret中</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Secret</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> gitlab-ci-token</span><br><span class="line"><span class="symbol">  namespace:</span> gitlab <span class="meta"># 指定命名空间</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> gitlab-ci-runner</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line"><span class="symbol">  GITLAB_CI_TOKEN:</span> SDRFQzdRMTJHc0NWc0RVMWpNLXkK <span class="meta"># 这是base64加密Gitlab runner token之后的字符串</span></span><br></pre></td></tr></table></figure><p>我们通过sts(statefulset控制器)gitlab-runner-sts.yaml创建Gitlab Runner。在开始运行的时候，尝试取消注册所有的同名 Runner，当节点丢失时（NodeLost事件）尤其有用。然后再尝试重新注册自己并开始运行。在正常停止 Pod 的时候，Runner 将会运行unregister命令来尝试取消自己，所以 Gitlab 就不能再使用这个 Runner 了，这个是通过 Kubernetes Pod 生命周期中的hooks来完成的，在运行Gitlab Runner的时候，我们通过Envfrom调用之前创建的脚本以及Gitlab runner运行需要的环境变量信息.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span> <span class="comment"># gitlab运行的命名空间</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># Gitlab Runner的更新模式</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-ci-runner-scripts</span></span><br><span class="line">        <span class="attr">projected:</span></span><br><span class="line">          <span class="attr">sources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">gitlab-ci-runner-scripts</span></span><br><span class="line">              <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">run.sh</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">run.sh</span></span><br><span class="line">                <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">gitlab-ci</span> <span class="comment"># 创建一个serviceAccount,创建pod</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">999</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span> <span class="string">[999]</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gitlab-runner:latest</span> <span class="comment"># 指定镜像的版本</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gitlab-ci-runner</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/scripts/run.sh</span></span><br><span class="line">        <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">gitlab-ci-runner-cm</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">gitlab-ci-token</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RUNNER_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-ci-runner-scripts</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">"/scripts"</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>从sts配置清单中看到，我们还需要一个ServiceAccount来有足够的权限做一些事情，因此我们创建一个gitlab-ci的ServiceAccount, 配置清单为:gitlab-runner-rbac.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-ci</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-ci</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["*"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["*"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-ci</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlab-ci</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-ci</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><p>上面都部署之后可以查看下runner是否连上了gitlab，runner状态为shared则表示正常。</p><p><img src="5.png" alt="upload-image"></p><p><img src="6.png" alt="upload-image"></p><h2 id="单独给某个项目部署runner"><a href="#单独给某个项目部署runner" class="headerlink" title="单独给某个项目部署runner"></a>单独给某个项目部署runner</h2><p>下面我们单独给某个项目配置一个runner，其实主要的区别就是采用token不一样。下面我们部署一下</p><p>首先我们将一个测试的项目上传到gitlab上，项目地址git clone <a href="https://github.com/haoshuwei/gitlab-ci-k8s-demo.git" target="_blank" rel="noopener">https://github.com/haoshuwei/gitlab-ci-k8s-demo.git</a></p><p>然后我们获取一下项目的token</p><p><img src="7.png" alt="upload-image"></p><p>下面我们通过helm方式来部署下runner</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/haoshuwei/gitlab-runner.git</span><br></pre></td></tr></table></figure><p>然后修改下value.yaml中的配置，主要是配置url和项目token进去，修改gitlabUrl和runnerRegistrationToken字段</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># GitLab Runner Image</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://hub.docker.com/r/gitlab-runner/tags/</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">image: gitlab-runner:alpine-v11.4.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Specify a imagePullPolicy</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 'Always' if imageTag is 'latest', else set to 'IfNotPresent'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Default container image to use for initcontainer</span></span></span><br><span class="line">init:</span><br><span class="line">  image: busybox</span><br><span class="line">  tag: latest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The GitLab Server URL (with protocol) that want to register the runner against</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-register</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">gitlabUrl: "http://gitlab.k8s.niewx.cn/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The Registration Token for adding new Runners to the GitLab Server. This must</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># be retreived from your GitLab Instance.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/ce/ci/runners/README.html#creating-and-registering-a-runner</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">runnerRegistrationToken: "Uw28p4b-Q2yJ8kHSGER7"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The Runner Token for adding new Runners to the GitLab Server. This must</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># be retreived from your GitLab Instance. It is token of already registered runner.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: (we don't yet have docs for that, but we want to use existing token)</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> runnerToken: <span class="string">""</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Unregister all runners before termination</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Updating the runner's chart version or configuration will cause the runner container</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># to be terminated and created again. This may cause your Gitlab instance to reference</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># non-existant runners. Un-registering the runner before termination mitigates this issue.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-unregister</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">unregisterRunners: true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Set the certsSecretName in order to pass custom certficates for GitLab Runner to use</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Provide resource name for a Kubernetes Secret Object in the same namespace,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># this is used to populate the /etc/gitlab-runner/certs directory</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> certsSecretName:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configure the maximum number of concurrent jobs</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">concurrent: 10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Defines in seconds how often to check GitLab for a new builds</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">checkInterval: 30</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configure GitLab Runner's logging level. Available values are: debug, info, warn, error, fatal, panic</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logLevel:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># For RBAC support:</span></span></span><br><span class="line">rbac:</span><br><span class="line">  create: true</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Run the gitlab-bastion container with the ability to deploy/manage containers of jobs</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># cluster-wide or only within namespace</span></span></span><br><span class="line">  clusterWideAccess: false</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> serviceAccountName: default</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configure integrated Prometheus metrics exporter</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server</span></span></span><br><span class="line">metrics:</span><br><span class="line">  enabled: true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configuration for the Pods that that the runner launches for each new job</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">runners:</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Default container image to use for builds when none is specified</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  image: ubuntu:16.04</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Specify one or more imagePullSecrets</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> imagePullSecrets: []</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> imagePullPolicy: <span class="string">""</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Specify whether the runner should be locked to a specific project: true, false. Defaults to true.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> locked: <span class="literal">true</span></span></span><br><span class="line">  </span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Specify the tags associated with the runner. Comma-separated list of tags.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/ce/ci/runners/#using-tags</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  tags: "k8s-runner"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Run all containers with the privileged flag enabled</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># This will allow the docker:dind image to run if you need to run Docker</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># commands. Please read the docs before turning this on:</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  privileged: true</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># The name of the secret containing runnerToken and runnerRegistrationToken</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> secret: gitlab-runner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  namespace: gitlab</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  cachePath: "/opt/cache"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Distributed runners caching</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># $ kubectl create secret generic s3access --\</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#   --from-literal=accesskey="YourAccessKey" \</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#   --from-literal=secretkey="YourSecretKey"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># ref: https://kubernetes.io/docs/concepts/configuration/secret/</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  cache: &#123;&#125;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> cacheType: s3</span></span><br><span class="line">    # s3ServerAddress: s3.amazonaws.com</span><br><span class="line">    # s3BucketName:</span><br><span class="line">    # s3BucketLocation:</span><br><span class="line">    # s3CacheInsecure: false</span><br><span class="line">    # s3CachePath: "gitlab_runner"</span><br><span class="line">    # cacheShared: true</span><br><span class="line">    # secretName: s3access</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Build Container specific configuration</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  builds: &#123;&#125;</span><br><span class="line">    # cpuLimit: 200m</span><br><span class="line">    # memoryLimit: 256Mi</span><br><span class="line">    # cpuRequests: 100m</span><br><span class="line">    # memoryRequests: 128Mi</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Service Container specific configuration</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  services: &#123;&#125;</span><br><span class="line">    # cpuLimit: 200m</span><br><span class="line">    # memoryLimit: 256Mi</span><br><span class="line">    # cpuRequests: 100m</span><br><span class="line">    # memoryRequests: 128Mi</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Helper Container specific configuration</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">  helpers: &#123;&#125;</span><br><span class="line">    # cpuLimit: 200m</span><br><span class="line">    # memoryLimit: 256Mi</span><br><span class="line">    # cpuRequests: 100m</span><br><span class="line">    # memoryRequests: 128Mi</span><br><span class="line">    # image: gitlab-runner-helper:x86_64-latest</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># Service Account to be used for runners</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> serviceAccountName:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># If Gitlab is not reachable through $CI_SERVER_URL</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> cloneUrl:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configure resource requests and limits</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: http://kubernetes.io/docs/user-guide/compute-resources/</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> limits:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">   memory: 256Mi</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">   cpu: 200m</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> requests:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">   memory: 128Mi</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">   cpu: 100m</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Configure environment variables that will be present when the registration command runs</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># This provides further control over the registration process and the config.toml file</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: `gitlab-runner register --help`</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> envVars:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   - name: RUNNER_EXECUTOR</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     value: kubernetes</span></span><br></pre></td></tr></table></figure><p>然后执行helm打包和部署命令进行部署</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="keyword">package</span> <span class="title">.</span></span><br><span class="line">helm install <span class="comment">--namespace gitlab gitlab-runner *.tgz</span></span><br></pre></td></tr></table></figure><p>GitLab Runner对缓存方案的支持有限，所以您需要使用挂载Volume的方式做缓存。在上面的示例中，安装GitLab Runner时默认使用/opt/cache目录作为缓存空间。您也可以通过修改values.yaml文件中的runners.cachePath字段修改缓存目录。</p><p>例如，如需建立Maven缓存，您可以在variables下添加MAVEN_OPTS变量并指定本地缓存目录：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  KUBECONFIG: /etc/deploy/config</span><br><span class="line">  MAVEN_OPTS: <span class="string">"-Dmaven.repo.local=/opt/cache/.m2/repository"</span></span><br></pre></td></tr></table></figure><p>修改templates/configmap.yaml文件中的以下字段挂载docker.sock和用于cache的volume。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/<span class="built_in">config</span>.toml &lt;&lt;EOF</span><br><span class="line">            <span class="string">[[runners.kubernetes.volumes.pvc]]</span></span><br><span class="line">              name = <span class="string">"gitlab-runner-cache"</span></span><br><span class="line">              mount_path = <span class="string">"&#123;&#123; .Values.runners.cachePath &#125;&#125;"</span></span><br><span class="line">            <span class="string">[[runners.kubernetes.volumes.host_path]]</span></span><br><span class="line">              name = <span class="string">"docker"</span></span><br><span class="line">              mount_path = <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">              read_only = <span class="literal">true</span></span><br><span class="line">              host_path = <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">    EOF</span><br></pre></td></tr></table></figure><p>runner pod运行成功后，在项目中可以查看到Runners activated for this project，则表示连接gitlab成功</p><p><img src="8.png" alt="upload-image"></p><h1 id="测试项目自动化部署到k8s集群中"><a href="#测试项目自动化部署到k8s集群中" class="headerlink" title="测试项目自动化部署到k8s集群中"></a>测试项目自动化部署到k8s集群中</h1><p>下面我们分别用gitlab-java-demo和gitlab-ci-k8s-demo这2个项目来测试下通过项目runner和全局runner将代码部署到k8s集群中</p><h2 id="项目runner部署gitlab-java-demo"><a href="#项目runner部署gitlab-java-demo" class="headerlink" title="项目runner部署gitlab-java-demo"></a>项目runner部署gitlab-java-demo</h2><p>首先我们给项目配置一下全局变量，.gitlab-ci.yml构建文件可以使用</p><p><img src="9.png" alt="upload-image"></p><ul><li>REGISTRY_USERNAME：镜像仓库用户名。</li><li>REGISTRY_PASSWORD：镜像仓库密码。</li><li>kube_config：KubeConfig的编码字符串。</li></ul><p>执行以下命令生成KubeConfig的编码字符串：echo $(cat ~/.kube/config | base64) | tr -d “ “</p><p>.gitlab-ci.yml如下</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">image: docker:stable</span><br><span class="line">stage<span class="variable">s:</span></span><br><span class="line">  - package</span><br><span class="line">  - docker_build</span><br><span class="line">  - deploy_k8s</span><br><span class="line">variable<span class="variable">s:</span></span><br><span class="line">  KUBECONFIG: /etc/deploy/config</span><br><span class="line">  MAVEN_OPTS: <span class="string">"-Dmaven.repo.local=/opt/cache/.m2/repository"</span></span><br><span class="line">mvn_build_jo<span class="variable">b:</span></span><br><span class="line">  image: maven:<span class="number">3.3</span>.<span class="number">9</span>-jdk-<span class="number">8</span></span><br><span class="line">  stage: package</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span></span><br><span class="line">    - k8s-runner</span><br><span class="line">  <span class="keyword">scrip</span><span class="variable">t:</span></span><br><span class="line">    - mvn package -B -DskipTests</span><br><span class="line">    - <span class="keyword">cp</span> target/demo.war /<span class="keyword">opt</span>/cache</span><br><span class="line">docker_build_jo<span class="variable">b:</span></span><br><span class="line">  image: docker:latest</span><br><span class="line">  stage: docker_build</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span></span><br><span class="line">    - k8s-runner</span><br><span class="line">  <span class="keyword">scrip</span><span class="variable">t:</span></span><br><span class="line">    - docker login -<span class="keyword">u</span> $REGISTRY_USERNAME -<span class="keyword">p</span> $REGISTRY_PASSWORD  ccr.ccs.tencentyun.<span class="keyword">com</span></span><br><span class="line">    - <span class="built_in">mkdir</span> target</span><br><span class="line">    - <span class="keyword">cp</span> /<span class="keyword">opt</span>/cache/demo.war target/demo.war</span><br><span class="line">    - docker build -t ccr.ccs.tencentyun.<span class="keyword">com</span>/v_cjweichen/nwx-re<span class="variable">g:</span>$CI_PIPELINE_ID .</span><br><span class="line">    - docker push ccr.ccs.tencentyun.<span class="keyword">com</span>/v_cjweichen/nwx-re<span class="variable">g:</span>$CI_PIPELINE_ID</span><br><span class="line">deploy_k8s_jo<span class="variable">b:</span></span><br><span class="line">  image: registry.<span class="keyword">cn</span>-hangzhou.aliyuncs.<span class="keyword">com</span>/haoshuwei24/kubect<span class="variable">l:1</span>.<span class="number">16.6</span></span><br><span class="line">  stage: deploy_k8s</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span></span><br><span class="line">    - k8s-runner</span><br><span class="line">  <span class="keyword">scrip</span><span class="variable">t:</span></span><br><span class="line">    - <span class="built_in">mkdir</span> -<span class="keyword">p</span> /etc/deploy</span><br><span class="line">    - <span class="keyword">echo</span> $kube_config |base64 -d &gt; $KUBECONFIG</span><br><span class="line">    - sed -i <span class="string">"s/IMAGE_TAG/$CI_PIPELINE_ID/g"</span> deployment.yaml</span><br><span class="line">    - <span class="keyword">cat</span> deployment.yaml</span><br><span class="line">    - kubectl apply -<span class="keyword">f</span> deployment.yaml</span><br></pre></td></tr></table></figure><p>将代码提交后则会自动构建，构建成功会根据项目的deployment.yaml文件将pod部署k8s集群中。</p><h2 id="全局runner部署gitlab-ci-k8s-demo"><a href="#全局runner部署gitlab-ci-k8s-demo" class="headerlink" title="全局runner部署gitlab-ci-k8s-demo"></a>全局runner部署gitlab-ci-k8s-demo</h2><p>测试代码如下：<a href="https://github.com/nieweixing/gitlab-ci-k8s-demo" target="_blank" rel="noopener">https://github.com/nieweixing/gitlab-ci-k8s-demo</a></p><p>首先我们给项目配置一下全局变量，.gitlab-ci.yml构建文件可以使用</p><p><img src="9.png" alt="upload-image"></p><p>分配配置如下几个变量</p><p><img src="10.png" alt="upload-image"></p><ul><li>镜像地址：CI_REGISTRY_IMAGE</li><li>镜像仓库密码：CI_REGISTRY_PASSWORD</li><li>镜像仓库用户名：CI_REGISTRY_USER</li></ul><p>为了能够创建和删除一些资源，我们也需要对象的 RBAC 权限，这里为了简单，我们直接新建一个ServiceAccount，绑定上一个tke:admin的权限(gitlab-sa.yaml)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tke:admin</span></span><br></pre></td></tr></table></figure><p>然后我们获取一下ServiceAccount的token和集群的ca证书，已经api地址，进行k8s集群的配置</p><p><img src="11.png" alt="upload-image"></p><p>下面我们配置一下.gitlab-ci.yml，内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">golang:1.10.3-stretch</span></span><br><span class="line">  <span class="attr">entrypoint:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The problem is that to be able to use go get, one needs to put</span></span><br><span class="line"><span class="comment"># the repository in the $GOPATH. So for example if your gitlab domain</span></span><br><span class="line"><span class="comment"># is mydomainperso.com, and that your repository is repos/projectname, and</span></span><br><span class="line"><span class="comment"># the default GOPATH being /go, then you'd need to have your</span></span><br><span class="line"><span class="comment"># repository in /go/src/mydomainperso.com/repos/projectname</span></span><br><span class="line"><span class="comment"># Thus, making a symbolic link corrects this.</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">"/go/src/git.qikqiak.com/$&#123;CI_PROJECT_NAMESPACE&#125;"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ln</span> <span class="string">-sf</span> <span class="string">"$&#123;CI_PROJECT_DIR&#125;"</span> <span class="string">"/go/src/git.qikqiak.com/$&#123;CI_PROJECT_PATH&#125;"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">"/go/src/git.qikqiak.com/$&#123;CI_PROJECT_PATH&#125;/"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">review</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">make</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test2:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">"We did it! Something else runs in parallel!"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">compile:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment"># Add here all the dependencies, or use glide/govendor/...</span></span><br><span class="line">    <span class="comment"># to get them automatically.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">make</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image_build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">release</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay</span></span><br><span class="line">    <span class="attr">DOCKER_HOST:</span> <span class="string">tcp://localhost:2375</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker:17.03-dind</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">["--insecure-registry=ccr.ccs.tencentyun.com"]</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">info</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">"$&#123;CI_REGISTRY_USER&#125;"</span> <span class="string">-p</span> <span class="string">"$&#123;CI_REGISTRY_PASSWORD&#125;"</span> <span class="string">ccr.ccs.tencentyun.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">"$&#123;CI_REGISTRY_IMAGE&#125;:latest"</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">tag</span> <span class="string">"$&#123;CI_REGISTRY_IMAGE&#125;:latest"</span> <span class="string">"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">!</span> <span class="string">-z</span> <span class="string">"$&#123;CI_COMMIT_TAG&#125;"</span> <span class="string">&amp;&amp;</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">"$&#123;CI_REGISTRY_IMAGE&#125;:latest"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">"$&#123;CI_REGISTRY_IMAGE&#125;:$&#123;CI_COMMIT_REF_NAME&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_review:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">cnych/kubectl</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">branches</span></span><br><span class="line">  <span class="attr">except:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://dev-gitlab-k8s-demo.k8s.niewx.cn</span></span><br><span class="line">    <span class="attr">on_stop:</span> <span class="string">stop_review</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">manifests/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/"</span> <span class="string">deployment.yaml</span> <span class="string">ingress.yaml</span> <span class="string">service.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/"</span> <span class="string">deployment.yaml</span> <span class="string">ingress.yaml</span> <span class="string">service.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">      <span class="string">if</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deployment.yaml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-q</span> <span class="string">unchanged;</span> <span class="string">then</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"=&gt; Patching deployment to force image update."</span></span><br><span class="line">          <span class="string">kubectl</span> <span class="string">patch</span> <span class="string">-f</span> <span class="string">deployment.yaml</span> <span class="string">-p</span> <span class="string">"&#123;\"spec\":&#123;\"template\":&#123;\"metadata\":&#123;\"annotations\":&#123;\"ci-last-updated\":\"$(date +'%s')\"&#125;&#125;&#125;&#125;&#125;"</span></span><br><span class="line">      <span class="string">else</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"=&gt; Deployment apply has changed the object, no need to force image update."</span></span><br><span class="line">      <span class="string">fi</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service.yaml</span> <span class="string">||</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ingress.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">status</span> <span class="string">-f</span> <span class="string">deployment.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all,ing</span> <span class="string">-l</span> <span class="string">ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stop_review:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">cnych/kubectl</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">review</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">GIT_STRATEGY:</span> <span class="string">none</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">branches</span></span><br><span class="line">  <span class="attr">except:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">stop</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">delete</span> <span class="string">ing</span> <span class="string">-l</span> <span class="string">ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">delete</span> <span class="string">all</span> <span class="string">-l</span> <span class="string">ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_live:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">cnych/kubectl</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">live</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://live-gitlab-k8s-demo.k8s.niewx.cn</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">version</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">manifests/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__CI_ENVIRONMENT_SLUG__/$&#123;CI_ENVIRONMENT_SLUG&#125;/"</span> <span class="string">deployment.yaml</span> <span class="string">ingress.yaml</span> <span class="string">service.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">"s/__VERSION__/$&#123;CI_COMMIT_REF_NAME&#125;/"</span> <span class="string">deployment.yaml</span> <span class="string">ingress.yaml</span> <span class="string">service.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deployment.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">ingress.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">status</span> <span class="string">-f</span> <span class="string">deployment.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all,ing</span> <span class="string">-l</span> <span class="string">ref=$&#123;CI_ENVIRONMENT_SLUG&#125;</span></span><br></pre></td></tr></table></figure><p>对应的部署yaml文件如下</p><p>部署deloyment文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gitlab-k8s-demo</span></span><br><span class="line">    <span class="attr">ref:</span> <span class="string">__CI_ENVIRONMENT_SLUG__</span></span><br><span class="line">    <span class="attr">track:</span> <span class="string">stable</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">gitlab-k8s-demo</span></span><br><span class="line">      <span class="attr">ref:</span> <span class="string">__CI_ENVIRONMENT_SLUG__</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">gitlab-k8s-demo</span></span><br><span class="line">        <span class="attr">ref:</span> <span class="string">__CI_ENVIRONMENT_SLUG__</span></span><br><span class="line">        <span class="attr">track:</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myregistry</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/v_cjweichen/nwx-reg:__VERSION__</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>service yaml文件</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span><br><span class="line">  <span class="attribute">namespace</span>: gitlab</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: gitlab-k8s-demo</span><br><span class="line">    <span class="attribute">ref</span>: __CI_ENVIRONMENT_SLUG__</span><br><span class="line">  <span class="attribute">annotations</span>:</span><br><span class="line">    prometheus.io/<span class="attribute">scrape</span>: <span class="string">"true"</span></span><br><span class="line">    prometheus.io/<span class="attribute">port</span>: <span class="string">"8000"</span></span><br><span class="line">    prometheus.io/<span class="attribute">scheme</span>: <span class="string">"http"</span></span><br><span class="line">    prometheus.io/<span class="attribute">path</span>: <span class="string">"/metrics"</span></span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">type</span>: ClusterIP</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">    - <span class="attribute">name</span>: http-metrics</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">8000</span></span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">app</span>: gitlab-k8s-demo</span><br><span class="line">    <span class="attribute">ref</span>: __CI_ENVIRONMENT_SLUG__</span><br></pre></td></tr></table></figure><p>traefik ingress暴露域名文件</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: traefik.containo.us/v1alpha1</span><br><span class="line"><span class="attribute">kind</span>: IngressRoute</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span><br><span class="line">  <span class="attribute">namespace</span>: gitlab</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">entryPoints</span>:</span><br><span class="line">    - web</span><br><span class="line">  <span class="attribute">routes</span>:</span><br><span class="line">  - <span class="attribute">match</span>: Host(<span class="built_in">`__CI_ENVIRONMENT_SLUG__.k8s.niewx.cn`</span>)</span><br><span class="line">    <span class="attribute">kind</span>: Rule</span><br><span class="line">    <span class="attribute">services</span>:</span><br><span class="line">    - <span class="attribute">name</span>: gitlab-k8s-demo-__CI_ENVIRONMENT_SLUG__</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">8000</span></span><br></pre></td></tr></table></figure><p>将上述文件提交到gitlab就会自动执行构建，构建成功会把应用自动部署到k8s上</p><p><img src="12.png" alt="upload-image"></p><p>然后我们通过<a href="http://dev-gitlab-k8s-demo.k8s.niewx.cn访问下，如果出现如下信息则部署访问成功" target="_blank" rel="noopener">http://dev-gitlab-k8s-demo.k8s.niewx.cn访问下，如果出现如下信息则部署访问成功</a></p><p><img src="13.png" alt="upload-image"></p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/" target="_blank" rel="noopener">https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/</a></p><p><a href="https://mp.weixin.qq.com/s/GHykQWgEtDYgFIeRca8dBw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/GHykQWgEtDYgFIeRca8dBw</a></p><p><a href="https://www.alibabacloud.com/help/zh/doc-detail/106968.htm?spm=a2c63.p38356.b99.660.3db53ce3ZRDjhM#title-xfl-dp6-kta" target="_blank" rel="noopener">https://www.alibabacloud.com/help/zh/doc-detail/106968.htm?spm=a2c63.p38356.b99.660.3db53ce3ZRDjhM#title-xfl-dp6-kta</a></p><hr><ul class="pager"><li class="previous"><a href="/2020/12/10/Automated-grayscale-release-of-istio-entry-series/" data-toggle="tooltip" data-placement="top" title="istio入门系列之自动化灰度发布">&larr; Previous Post</a></li><li class="next"><a href="/2020/12/08/Getting-started-in-actual-combat-of-istio-entry-series/" data-toggle="tooltip" data-placement="top" title="istio入门系列之实战入门准备flux自动化部署">Next Post &rarr;</a></li></ul><div class="comment_notes_blank"></div><div class="visitor_notice"><img src="/img/notice.png" alt="notice" title="notice"><p class="notice">欢迎访问 <a href="https://www.niewx.cn" target="Vashon">Vashon</a> 的博客，博客和文章在完善中，请大家耐心等待。 若有问题或者有好的建议欢迎留言，笔者看到之后会及时回复。 评论点赞需要github账号登录，如果没有账号的话请点击 <a href="https://github.com" target="view_window">github </a>注册， 谢谢 !</p></div><div class="comment_notes"><p></p></div><link rel="stylesheet" href="../../../../css/music-player/fonts/iconfont.css"><link rel="stylesheet" href="../../../../css/music-player/css/reset.css"><link rel="stylesheet" href="../../../../css/music-player/css/player.css"><div class="music-player"><audio class="music-player__audio"></audio><div class="music-player__main"><div class="music-player__blur"></div><div class="music-player__disc"><div class="music-player__image"><img width="100%" src="" alt=""></div><div class="music-player__pointer"><img width="100%" src="/img/cd_tou.png" alt=""></div></div><div class="music-player__controls"><div class="music__info"><h3 class="music__info--title">...</h3><p class="music__info--singer">...</p></div><div class="player-control"><div class="player-control__content"><div class="player-control__btns"><div class="player-control__btn player-control__btn--prev"><i class="iconfont icon-prev"></i></div><div class="player-control__btn player-control__btn--play"><i class="iconfont icon-play"></i></div><div class="player-control__btn player-control__btn--next"><i class="iconfont icon-next"></i></div><div class="player-control__btn player-control__btn--mode"><i class="iconfont icon-loop"></i></div></div><div class="player-control__volume"><div class="control__volume--icon player-control__btn"><i class="iconfont icon-volume"></i></div><div class="control__volume--progress player_progress"></div></div></div><div class="player-control__content"><div class="player__song--progress player_progress"></div><div class="player__song--timeProgess nowTime">00:00</div><div class="player__song--timeProgess totalTime">00:00</div></div></div></div></div></div><script src="../../../../js/music-player/utill.js"></script><script src="../../../../js/music-player/jquery.min.js"></script><script src="../../../../js/music-player/player.js?library=netease&music=https://kg.qq.com/node/play?s=7deFpz7Z26Jmv7di&g_f=share_html"></script><div class="social-share" data-wechat-qrcode-helper="" align="center"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script><hr><div id="lv-container" data-id="city" data-uid="MTAyMC80NzQ3MS8yMzk3MQ=="><script type="text/javascript">!function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((t=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",t.async=!0,n.parentNode.insertBefore(t,n))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#搭建gitlab"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">搭建gitlab</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#redis部署"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">redis部署</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#postgresql部署"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">postgresql部署</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#gitlab部署"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">gitlab部署</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#验证登录gitlab"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">验证登录gitlab</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#配置gitlab-runner"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">配置gitlab-runner</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#部署全局的runner进行使用"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">部署全局的runner进行使用</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#单独给某个项目部署runner"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">单独给某个项目部署runner</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#测试项目自动化部署到k8s集群中"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">测试项目自动化部署到k8s集群中</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#项目runner部署gitlab-java-demo"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">项目runner部署gitlab-java-demo</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#全局runner部署gitlab-ci-k8s-demo"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">全局runner部署gitlab-ci-k8s-demo</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#参考文档"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">参考文档</span></a></li></ol></div></aside><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a> <a class="tag" href="/tags/#TKE" title="TKE">TKE</a> <a class="tag" href="/tags/#Devops" title="Devops">Devops</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://cloud.tencent.com/developer/column/87421" target="_blank">云+社区</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">gitbook</a></li><li><a href="https://github.com/nieweixing" target="_blank">vashon&#39;s Github</a></li><li><a href="https://weibo.com/3264907804/profile?rig" target="_blank">weibo</a></li></ul></div></div></div></article><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style type="text/css">@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://twitter.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.facebook.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/ke-wang-mian-bao-de-you-xia"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 聂伟星 2021<br>Powered by <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener"><i>hexo-theme-snail</i> </a>|<iframe name="star" style="margin-left:2px;margin-bottom:-5px" frameborder="0" scrolling="0" width="100px" height="20px" src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true"></iframe></p></div></div></div></footer><script src="../../../../js/jquery.min.js"></script><script src="../../../../js/bootstrap.min.js"></script><script src="../../../../js/hux-blog.min.js"></script><script src="../../../../js/search.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>0!==$("#tag_cloud").length&&async("https://www.niewx.cn/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="bfe4709ccd8c5c9e559c89f4fd0866f3",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><script type="text/javascript">var search_path="search.xml",path="/"+(search_path=0==search_path.length?"search.xml":search_path);searchFunc(path,"local-search-input","local-search-result")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><a id="rocket" href="#top" class=""></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/mouse-click.js" content="[&#34;🌱&#34;,&#34;just do it&#34;,&#34;🍀&#34;]" color="[&#34;rgb(121,93,179)&#34; ,&#34;rgb(76,180,231)&#34; ,&#34;rgb(184,90,154)&#34;]"></script><script src="/js/ribbonDynamic.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"left","width":250,"height":500},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>