<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="聂伟星个人技术博客"><meta name="keyword" content="聂伟星，博客"><link rel="shortcut icon" href="/img/ironman-draw.png"><script async defer="defer" src="https://buttons.github.io/buttons.js"></script><title>kubernetes之StatefulSet控制器 - 聂伟星个人技术博客</title><link rel="canonical" href="https://www.niewx.cn/2020/10/23/StatefulSet-controller-of-kubernetes/"><link rel="stylesheet" href="../../../../css/bootstrap.min.css"><link rel="stylesheet" href="../../../../css/dusign-light.css"><link rel="stylesheet" href="../../../../css/dusign-common-light.css"><link rel="stylesheet" href="../../../../css/font-awesome.css"><link rel="stylesheet" href="../../../../css/toc.css"><link rel="stylesheet" href="../../../../css/highlight.css"><link rel="stylesheet" href="../../../../css/widget.css"><link rel="stylesheet" href="../../../../css/rocket.css"><link rel="stylesheet" href="../../../../css/signature.css"><link rel="stylesheet" href="../../../../css/fonts.googleapis.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="../../../../css/photography.css"><script></script><meta name="generator" content="Hexo 4.2.1"></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(snail-bg.jpg)}#signature{background-image:url(/img/signature/1291.png)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a></div><h1>kubernetes之StatefulSet控制器</h1><h2 class="subheading"></h2><span class="meta">Posted by VashonNie on 2020-10-23</span><div class="blank_box"></div><span class="meta">Words <span class="post-count">4.2k</span> and Reading Time <span class="post-count">18</span> Minutes</span><div class="blank_box"></div><span class="meta">Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times</span></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(/img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">聂伟星</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archive/">Archives</a></li><li><a href="/photography/">Photography</a></li><li><a href="/categories/">Categories</a></li><li><a href="/tags/">Tags</a></li><li><a href="/random.html">随机文章</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">运维操作宝典</a></li><li><a href="https://www.niewx.cn/question/" target="_blank">运维问题集锦</a></li><li><a href="https://cloud.tencent.com/developer/column/87421" target="_blank">tke运维文档</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><p>本文将带你了解k8s中的StatefulSet控制器，将通过实验的方式来说明StatefulSet的用法和配置，让你快速能够将StatefulSet类型的服务用到你的k8s集群中。</p><h1 id="什么是StatefulSet"><a href="#什么是StatefulSet" class="headerlink" title="什么是StatefulSet"></a>什么是StatefulSet</h1><p>StatefulSet 是用来管理有状态应用的工作负载 API 对象。</p><p>StatefulSet 用来管理 Deployment 和扩展一组 Pod，并且能为这些 Pod 提供序号和唯一性保证。</p><p>和 Deployment 相同的是，StatefulSet 管理了基于相同容器定义的一组 Pod。但和 Deployment 不同的是，StatefulSet 为它们的每个 Pod 维护了一个固定的 ID。这些 Pod 是基于相同的声明来创建的，但是不能相互替换：无论怎么调度，每个 Pod 都有一个永久不变的 ID。</p><p>StatefulSet 和其他控制器使用相同的工作模式。你在 StatefulSet 对象 中定义你期望的状态，然后 StatefulSet 的 控制器 就会通过各种更新来达到那种你想要的状态。</p><p>StatefulSets 对于需要满足以下一个或多个需求的应用程序很有价值：</p><ul><li>稳定的、唯一的网络标识符。</li><li>稳定的、持久的存储。</li><li>有序的、优雅的部署和缩放。</li><li>有序的、自动的滚动更新。</li></ul><p>在上面，稳定意味着 Pod 调度或重调度的整个过程是有持久性的。如果应用程序不需要任何稳定的标识符或有序的部署、删除或伸缩，则应该使用由一组无状态的副本控制器提供的工作负载来部署应用程序，比如 Deployment 或者 ReplicaSet 可能更适用于您的无状态应用部署需要。</p><p><strong>使用限制</strong></p><ul><li>给定 Pod 的存储必须由 PersistentVolume 驱动 基于所请求的 storage class 来提供，或者由管理员预先提供。</li><li>删除或者收缩 StatefulSet 并不会删除它关联的存储卷。这样做是为了保证数据安全，它通常比自动清除 StatefulSet 所有相关的资源更有价值。</li><li>StatefulSet 当前需要无头服务 来负责 Pod 的网络标识。您需要负责创建此服务。</li><li>当删除 StatefulSets 时，StatefulSet 不提供任何终止 Pod 的保证。为了实现 StatefulSet 中的 Pod 可以有序和优雅的终止，可以在删除之前将 StatefulSet 缩放为 0。</li><li>在默认 Pod 管理策略(OrderedReady) 时使用 滚动更新，可能进入需要 人工干预 才能修复的损坏状态。</li></ul><h1 id="pod的标识符"><a href="#pod的标识符" class="headerlink" title="pod的标识符"></a>pod的标识符</h1><p>StatefulSet Pod 具有唯一的标识，该标识包括顺序标识、稳定的网络标识和稳定的存储。该标识和 Pod 是绑定的，不管它被调度在哪个节点上。注意的是StatefulSet 需要通过无头服务才能解析到pod ip</p><p>有序索引<br>对于具有 N 个副本的 StatefulSet，StatefulSet 中的每个 Pod 将被分配一个整数序号，从 0 到 N-1，该序号在 StatefulSet 上是唯一的。</p><p>稳定的网络 ID<br>StatefulSet 中的每个 Pod 根据 StatefulSet 的名称和 Pod 的序号派生出它的主机名。 组合主机名的格式为$(StatefulSet 名称)-$(序号)。上例将会创建三个名称分别为 web-0、web-1、web-2 的 Pod。 StatefulSet 可以使用 headless 服务 控制它的 Pod 的网络域。管理域的这个服务的格式为： $(服务名称).$(命名空间).svc.cluster.local，其中 cluster.local 是集群域。 一旦每个 Pod 创建成功，就会得到一个匹配的 DNS 子域，格式为： $(pod 名称).$(所属服务的 DNS 域名)，其中所属服务由 StatefulSet 的 serviceName 域来设定。</p><p>下面给出一些选择集群域、服务名、StatefulSet 名、及其怎样影响 StatefulSet 的 Pod 上的 DNS 名称的示例</p><div class="table-container"><table><thead><tr><th>集群域名</th><th>服务(名字空间/名字)</th><th>StatefulSet(名字空间/名字)</th><th>StatefulSet 域名</th><th>Pod DNS</th><th>Pod 主机名</th></tr></thead><tbody><tr><td>cluster.local</td><td>default/nginx</td><td>default/web</td><td>nginx.default.svc.cluster.local</td><td>web-{0..N-1}.nginx.default.svc.cluster.local</td><td>web-{0..N-1}</td></tr><tr><td>cluster.local</td><td>foo/nginx</td><td>foo/web</td><td>nginx.foo.svc.cluster.local</td><td>web-{0..N-1}.nginx.foo.svc.cluster.local</td><td>web-{0..N-1}</td></tr><tr><td>kube.local</td><td>foo/nginx</td><td>foo/web</td><td>nginx.foo.svc.kube.local</td><td>web-{0..N-1}.nginx.foo.svc.kube.local</td><td>web-{0..N-1}</td></tr></tbody></table></div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># has to match .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># by default is 1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># has to match .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure><p>下面我们在其他容器中解析一下pod名称看一下是否能解析到pod ip</p><p><img src="1.png" alt="upload-image"></p><p>我们在centos容器中解析对应的pod名称看看,可以发现解析每个pod名称都能成功到pod ip，pod标识符也正是StatefulSet 独有的特性。</p><p><img src="2.png" alt="upload-image"></p><h1 id="稳定的存储"><a href="#稳定的存储" class="headerlink" title="稳定的存储"></a>稳定的存储</h1><p>Kubernetes 为每个 VolumeClaimTemplate 创建一个 PersistentVolumes。 在上面的 nginx 示例中，每个 Pod 将会得到基于 StorageClass cbs 提供的 10 Gib 的 PersistentVolume。如果没有声明 StorageClass，就会使用默认的 StorageClass。 当一个 Pod 被调度（重新调度）到节点上时，它的 volumeMounts 会挂载与其 PersistentVolumeClaims 相关联的 PersistentVolume。 请注意，当 Pod 或者 StatefulSet 被删除时，与 PersistentVolumeClaims 相关联的 PersistentVolume 并不会被删除。要删除它必须通过手动方式来完成。</p><p>下面我们来测试一下将pod都删除看看，对应的pvc是否会删除</p><p><img src="3.png" alt="upload-image"></p><p><img src="4.png" alt="upload-image"></p><p>删除了所有pod，对用挂载的pvc卷是不会删除的。</p><h1 id="Pod-名称标签"><a href="#Pod-名称标签" class="headerlink" title="Pod 名称标签"></a>Pod 名称标签</h1><p>当 StatefulSet 控制器 创建 Pod 时，它会添加一个标签 statefulset.kubernetes.io/pod-name，该标签设置为 Pod 名称。这个标签允许您给 StatefulSet 中的特定 Pod 绑定一个 Service。<br></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM_1_4_centos ~]# kubectl <span class="keyword">get</span> pod --show-labels | grep webss</span><br><span class="line">webss<span class="number">-0</span>                                   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">76</span>m   app=nginx,controller-revision-hash=webss<span class="number">-6</span>d657db877,k8s-app=webss,qcloud-app=webss,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=nginx,service.istio.io/canonical-revision=latest,statefulset.kubernetes.io/pod-name=webss<span class="number">-0</span></span><br><span class="line">webss<span class="number">-1</span>                                   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">75</span>m   app=nginx,controller-revision-hash=webss<span class="number">-6</span>d657db877,k8s-app=webss,qcloud-app=webss,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=nginx,service.istio.io/canonical-revision=latest,statefulset.kubernetes.io/pod-name=webss<span class="number">-1</span></span><br><span class="line">webss<span class="number">-2</span>                                   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">74</span>m   app=nginx,controller-revision-hash=webss<span class="number">-6</span>d657db877,k8s-app=webss,qcloud-app=webss,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=nginx,service.istio.io/canonical-revision=latest,statefulset.kubernetes.io/pod-name=webss<span class="number">-2</span></span><br></pre></td></tr></table></figure><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@VM_1_4_centos</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span>  <span class="string">webss-0</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2020-10-25T03:06:35Z"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webss-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"14187854412"</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/services/webss-0</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">16f50d64-533c-4c55-acb6-d7512d86cc58</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">172.16</span><span class="number">.255</span><span class="number">.138</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">statefulset.kubernetes.io/pod-name:</span> <span class="string">webss-0</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><br>这边可以通过这个svc单独访问到webss-0<p></p><h1 id="StatefulSet的创建和扩缩容"><a href="#StatefulSet的创建和扩缩容" class="headerlink" title="StatefulSet的创建和扩缩容"></a>StatefulSet的创建和扩缩容</h1><ul><li>对于包含 N 个 副本的 StatefulSet，当部署 Pod 时，它们是依次创建的，顺序为 0..N-1。</li><li>当删除 Pod 时，它们是逆序终止的，顺序为 N-1..0。</li><li>在将缩放操作应用到 Pod 之前，它前面的所有 Pod 必须是 Running 和 Ready 状态。</li><li>在 Pod 终止之前，所有的继任者必须完全关闭。</li></ul><p>StatefulSet 不应将 pod.Spec.TerminationGracePeriodSeconds 设置为 0。 这种做法是不安全的，要强烈阻止。更多的解释请参考 强制删除 StatefulSet Pod。</p><p><img src="5.png" alt="upload-image"></p><p>在上面的 nginx 示例被创建后，会按照 webss-0、webss-1、webss-2 的顺序部署三个 Pod。 在 web-0 进入 Running 和 Ready 状态前不会部署 webss-1。在 webss-1 进入 Running 和 Ready 状态前不会部署 webss-2。 如果 web-1 已经处于 Running 和 Ready 状态，而 webss-2 尚未部署，在此期间发生了 web-0 运行失败，那么 webss-2 将不会被部署，要等到 webss-0 部署完成并进入 Running 和 Ready 状态后，才会部署 web-2。</p><p>如果用户想将示例中的 StatefulSet 收缩为 replicas=0，首先被终止的是 webss-2。在 webss-2 没有被完全停止和删除前，webss-1 不会被终止。当 webss-2 已被终止和删除、webss-1 尚未被终止，如果在此期间发生 webss-0 运行失败，那么就不会终止 webss-1，必须等到 webss-0 进入 Running 和 Ready 状态后才会终止 webss-1。</p><p>我们可以先删除pod，然后创建pod，看下对应的event日志<br></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_1_4_centos ~]# kubectl describe sts webss</span><br><span class="line">Name:               webss</span><br><span class="line">Namespace:          default</span><br><span class="line">CreationTimestamp:  Sun, 25 Oct 2020 09:39:47 +0800</span><br><span class="line">Selector:           <span class="attribute">app</span>=nginx,k8s-app=webss,qcloud-app=webss</span><br><span class="line">Labels:             <span class="attribute">app</span>=nginx</span><br><span class="line">                    <span class="attribute">k8s-app</span>=webss</span><br><span class="line">                    <span class="attribute">qcloud-app</span>=webss</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Replicas:           3 desired | 3 total</span><br><span class="line">Update Strategy:    RollingUpdate</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">Events:</span><br><span class="line"> <span class="built_in"> Type </span>   Reason            Age                  <span class="keyword">From</span>                    Message</span><br><span class="line">  ----    ------            ----                 ----                    -------</span><br><span class="line">  Normal  SuccessfulDelete  118s (x2 over 151m)  statefulset-controller  delete Pod webss-2 <span class="keyword">in</span> StatefulSet webss successful</span><br><span class="line">  Normal  SuccessfulDelete  111s (x2 over 151m)  statefulset-controller  delete Pod webss-1 <span class="keyword">in</span> StatefulSet webss successful</span><br><span class="line">  Normal  SuccessfulDelete  97s (x2 over 151m)   statefulset-controller  delete Pod webss-0 <span class="keyword">in</span> StatefulSet webss successful</span><br><span class="line">  Normal  SuccessfulCreate  70s (x3 over 3h49m)  statefulset-controller  create Pod webss-0 <span class="keyword">in</span> StatefulSet webss successful</span><br><span class="line">  Normal  SuccessfulCreate  47s (x3 over 3h49m)  statefulset-controller  create Pod webss-1 <span class="keyword">in</span> StatefulSet webss successful</span><br><span class="line">  Normal  SuccessfulCreate  24s (x3 over 3h48m)  statefulset-controller  create Pod webss-2 <span class="keyword">in</span> StatefulSet webss successful</span><br></pre></td></tr></table></figure><br>可以发现pod的启动是按照顺序创建和删除的<p></p><p><strong>podManagementPolicy管理pod</strong></p><p>那么StatefulSet 是如何保证对应的pod按照顺序启动的呢，必须需要等前面一个pod启动才能启动后面的pod，那么我们可以去除这个依赖来启动pod吗？让pod并行启动，这边当然是可以的。StatefulSet可以通过podManagementPolicy这个参数来配置pod的启动顺序。</p><p>podManagementPolicy: OrderedReady这个是默认的配置，就是按照一定的顺序先后启动。</p><p>podManagementPolicy可以将值设置为Parallel，这个值就是StatefulSet 控制器并行的启动或终止所有的 Pod， 启动或者终止其他 Pod 前，无需等待 Pod 进入 Running 和 ready 或者完全停止状态。<br></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> apps/v1</span><br><span class="line"><span class="symbol">kind:</span> StatefulSet</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  annotations:</span></span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1"</span>,<span class="string">"kind"</span>:<span class="string">"StatefulSet"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"name"</span>:<span class="string">"web"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"podManagementPolicy"</span>:<span class="string">"Parallel"</span>,<span class="string">"replicas"</span>:<span class="number">3</span>,<span class="string">"selector"</span>:&#123;<span class="string">"matchLabels"</span>:&#123;<span class="string">"app"</span>:<span class="string">"nginx"</span>&#125;&#125;,<span class="string">"serviceName"</span>:<span class="string">"nginx"</span>,<span class="string">"template"</span>:&#123;<span class="string">"metadata"</span>:&#123;<span class="string">"labels"</span>:&#123;<span class="string">"app"</span>:<span class="string">"nginx"</span>&#125;&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"containers"</span>:[&#123;<span class="string">"image"</span>:<span class="string">"k8s.gcr.io/nginx-slim:0.8"</span>,<span class="string">"name"</span>:<span class="string">"nginx"</span>,<span class="string">"ports"</span>:[&#123;<span class="string">"containerPort"</span>:<span class="number">80</span>,<span class="string">"name"</span>:<span class="string">"web"</span>&#125;]&#125;],<span class="string">"terminationGracePeriodSeconds"</span>:<span class="number">10</span>&#125;&#125;&#125;&#125;</span><br><span class="line"><span class="symbol">  creationTimestamp:</span> <span class="string">"2020-10-25T05:42:38Z"</span></span><br><span class="line"><span class="symbol">  generation:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">  name:</span> web</span><br><span class="line"><span class="symbol">  namespace:</span> default</span><br><span class="line"><span class="symbol">  resourceVersion:</span> <span class="string">"8286286"</span></span><br><span class="line"><span class="symbol">  selfLink:</span> <span class="meta-keyword">/apis/</span>apps<span class="meta-keyword">/v1/</span>namespaces<span class="meta-keyword">/default/</span>statefulsets/web</span><br><span class="line"><span class="symbol">  uid:</span> <span class="number">4e50</span>f5b0-d23d<span class="number">-4</span>fca<span class="number">-978</span>e-f3547c047dd3</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  podManagementPolicy:</span> Parallel</span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="symbol">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      app:</span> nginx</span><br><span class="line"><span class="symbol">  serviceName:</span> nginx</span><br><span class="line">....................</span><br></pre></td></tr></table></figure><br><img src="6.png" alt="upload-image"><p></p><p>可以从上面event事件看出，我们将podManagementPolicy设置为Parallel，pod是并行同时启动的</p><h1 id="StatefulSet的更新"><a href="#StatefulSet的更新" class="headerlink" title="StatefulSet的更新"></a>StatefulSet的更新</h1><p>在 Kubernetes 1.7 及以后的版本中，StatefulSet 的.spec.updateStrategy字段让您可以配置和禁用掉自动滚动更新 Pod 的容器、标签、资源请求或限制、以及注解。默认的配置是滚动更新</p><h2 id="RollingUpdate更新"><a href="#RollingUpdate更新" class="headerlink" title="RollingUpdate更新"></a>RollingUpdate更新</h2><p>RollingUpdate更新策略对 StatefulSet 中的 Pod 执行自动的滚动更新。在没有声明.spec.updateStrategy时，RollingUpdate是默认配置。 当 StatefulSet 的.spec.updateStrategy.type被设置为RollingUpdate时，StatefulSet 控制器会删除和重建 StatefulSet 中的每个 Pod。 它将按照与 Pod 终止相同的顺序（从最大序号到最小序号）进行，每次更新一个 Pod。它会等到被更新的 Pod 进入 Running 和 Ready 状态，然后再更新其前身。<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">updateStrategy:</span></span><br><span class="line">  <span class="attr">rollingUpdate:</span></span><br><span class="line">    <span class="attr">partition:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure><br>下面我们修改下镜像，看看滚动更新是否和上面描述一致，我们修改镜像版本为1.17版本，从事件看，更新顺序是先更新最大号序号，再更新最小序号的<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:<span class="number">1.17</span></span><br><span class="line">    Port:         <span class="number">80</span>/TCP</span><br><span class="line">    Host Port:    <span class="number">0</span>/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Volume Claims:    &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age                  From                    Message</span><br><span class="line">  ----    ------            ----                 ----                    -------</span><br><span class="line">  Normal  SuccessfulDelete  <span class="number">93</span>s                  statefulset-controller  delete Pod web<span class="number">-2</span> <span class="keyword">in</span> StatefulSet web successful</span><br><span class="line">  Normal  SuccessfulCreate  <span class="number">85</span>s (x2 over <span class="number">3</span>m28s)  statefulset-controller  create Pod web<span class="number">-2</span> <span class="keyword">in</span> StatefulSet web successful</span><br><span class="line">  Normal  SuccessfulDelete  <span class="number">46</span>s                  statefulset-controller  delete Pod web<span class="number">-1</span> <span class="keyword">in</span> StatefulSet web successful</span><br><span class="line">  Normal  SuccessfulCreate  <span class="number">36</span>s (x2 over <span class="number">4</span>m20s)  statefulset-controller  create Pod web<span class="number">-1</span> <span class="keyword">in</span> StatefulSet web successful</span><br><span class="line">  Normal  SuccessfulDelete  <span class="number">12</span>s                  statefulset-controller  delete Pod web<span class="number">-0</span> <span class="keyword">in</span> StatefulSet web successful</span><br><span class="line">  Normal  SuccessfulCreate  <span class="number">5</span>s (x2 over <span class="number">4</span>m59s)   statefulset-controller  create Pod web<span class="number">-0</span> <span class="keyword">in</span> StatefulSet web successful</span><br></pre></td></tr></table></figure><p></p><h2 id="OnDelete-更新"><a href="#OnDelete-更新" class="headerlink" title="OnDelete 更新"></a>OnDelete 更新</h2><p>OnDelete 更新策略实现了 1.6 及以前版本的历史遗留行为。当 StatefulSet 的 .spec.updateStrategy.type 设置为 OnDelete 时，它的控制器将不会自动更新 StatefulSet 中的 Pod。用户必须手动删除 Pod 以便让控制器创建新的 Pod，以此来对 StatefulSet 的 .spec.template 的变动作出反应。<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.17</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">    <span class="attr">securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">updateStrategy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">OnDelete</span></span><br></pre></td></tr></table></figure><br>下面我们把修改镜像成latest，看下对应的pod会不会更新<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">podManagementPolicy</span>: OrderedReady</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">3</span></span><br><span class="line">  <span class="attribute">revisionHistoryLimit</span>: <span class="number">10</span></span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">matchLabels</span>:</span><br><span class="line">      <span class="attribute">app</span>: nginx</span><br><span class="line">  <span class="attribute">serviceName</span>: nginx</span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">creationTimestamp</span>: null</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">app</span>: nginx</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">      - <span class="attribute">image</span>: <span class="attribute">nginx</span>:latest</span><br><span class="line">        <span class="attribute">imagePullPolicy</span>: Always</span><br><span class="line">        <span class="attribute">name</span>: nginx</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@VM-4-3-centos</span> ~]# kubectl delete pod web-<span class="number">1</span></span><br><span class="line">pod <span class="string">"web-1"</span> deleted</span><br><span class="line">[root<span class="variable">@VM-4-3-centos</span> ~]# kubectl get pod </span><br><span class="line">NAME    READY   STATUS              RESTARTS   AGE</span><br><span class="line">web-<span class="number">0</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">6</span>m</span><br><span class="line">web-<span class="number">1</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">2s</span></span><br><span class="line">web-<span class="number">2</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">7</span>m20s</span><br><span class="line">[root<span class="variable">@VM-4-3-centos</span> ~]# kubectl describe pod web-<span class="number">1</span></span><br><span class="line"><span class="attribute">Name</span>:           web-<span class="number">1</span></span><br><span class="line"><span class="attribute">Namespace</span>:      default</span><br><span class="line">.....................</span><br><span class="line"><span class="attribute">Events</span>:</span><br><span class="line">  Type    Reason     Age   From                     Message</span><br><span class="line">  ----    ------     ----  ----                     -------</span><br><span class="line">  Normal  Scheduled  <span class="number">11s</span>   default-scheduler        Successfully assigned default/web-<span class="number">1</span> to vm-<span class="number">4</span>-<span class="number">11</span>-centos</span><br><span class="line">  Normal  Pulling    <span class="number">10s</span>   kubelet, vm-<span class="number">4</span>-<span class="number">11</span>-centos  Pulling image <span class="string">"nginx:latest"</span></span><br><span class="line">  Normal  Pulled     <span class="number">0s</span>    kubelet, vm-<span class="number">4</span>-<span class="number">11</span>-centos  Successfully pulled image <span class="string">"nginx:latest"</span></span><br><span class="line">  Normal  Created    <span class="number">0s</span>    kubelet, vm-<span class="number">4</span>-<span class="number">11</span>-centos  Created container nginx</span><br><span class="line">  Normal  Started    <span class="number">0s</span>    kubelet, vm-<span class="number">4</span>-<span class="number">11</span>-centos  Started container nginx</span><br></pre></td></tr></table></figure><br>可以发现我们修改yaml后，pod并没有更新，只有手动删除某个pod后，pod才会进行更新<p></p><h2 id="分区更新"><a href="#分区更新" class="headerlink" title="分区更新"></a>分区更新</h2><p>通过声明.spec.updateStrategy.rollingUpdate.partition的方式，RollingUpdate更新策略可以实现分区。如果声明了一个分区，当 StatefulSet 的.spec.template被更新时，所有序号大于等于该分区序号的 Pod 都会被更新。所有序号小于该分区序号的 Pod 都不会被更新，并且，即使他们被删除也会依据之前的版本进行重建。如果 StatefulSet 的.spec.updateStrategy.rollingUpdate.partition大于它的.spec.replicas，对它的.spec.template的更新将不会传递到它的 Pod。 在大多数情况下，您不需要使用分区，但如果您希望进行阶段更新、执行金丝雀或执行分阶段展开，则这些分区会非常有用</p><p>这边通常spec.updateStrategy.rollingUpdate.partition一般需要小于replicas的数值，这样才会生效，下面我们来测试一下分区更新<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="string">[root@VM-4-3-centos</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">describe</span> <span class="string">sts</span> <span class="string">web</span></span><br><span class="line"><span class="attr">Name:</span>               <span class="string">web</span></span><br><span class="line"><span class="attr">Namespace:</span>          <span class="string">default</span></span><br><span class="line"><span class="attr">CreationTimestamp:</span>  <span class="string">Sun,</span> <span class="number">25</span> <span class="string">Oct</span> <span class="number">2020</span> <span class="number">14</span><span class="string">:09:02</span> <span class="string">+0800</span></span><br><span class="line"><span class="attr">Selector:</span>           <span class="string">app=nginx</span></span><br><span class="line"><span class="attr">Labels:</span>             <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:        kubectl.kubernetes.io/last-applied-configuration:</span></span><br><span class="line">                      <span class="string">&#123;"apiVersion":"apps/v1","kind":"StatefulSet","metadata":&#123;"annotations":&#123;&#125;,"name":"web","namespace":"default"&#125;,"spec":&#123;"podManagementPolicy...</span></span><br><span class="line"><span class="attr">Replicas:</span>           <span class="number">3</span> <span class="string">desired</span> <span class="string">|</span> <span class="number">3</span> <span class="string">total</span></span><br><span class="line"><span class="attr">Update Strategy:</span>    <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">Partition:</span>        <span class="number">824636860812</span></span><br><span class="line"><span class="attr">Pods Status:</span>        <span class="number">3</span> <span class="string">Running</span> <span class="string">/</span> <span class="number">0</span> <span class="string">Waiting</span> <span class="string">/</span> <span class="number">0</span> <span class="string">Succeeded</span> <span class="string">/</span> <span class="number">0</span> <span class="string">Failed</span></span><br><span class="line"><span class="string">........</span></span><br><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="string">Type</span>    <span class="string">Reason</span>            <span class="string">Age</span>                  <span class="string">From</span>                    <span class="string">Message</span></span><br><span class="line">  <span class="string">----</span>    <span class="string">------</span>            <span class="string">----</span>                 <span class="string">----</span>                    <span class="string">-------</span></span><br><span class="line">  <span class="string">Normal</span>  <span class="string">SuccessfulCreate</span>  <span class="string">5m8s</span>                 <span class="string">statefulset-controller</span>  <span class="string">create</span> <span class="string">Pod</span> <span class="string">web-0</span> <span class="string">in</span> <span class="string">StatefulSet</span> <span class="string">web</span> <span class="string">successful</span></span><br><span class="line">  <span class="string">Normal</span>  <span class="string">SuccessfulCreate</span>  <span class="string">4m32s</span>                <span class="string">statefulset-controller</span>  <span class="string">create</span> <span class="string">Pod</span> <span class="string">web-1</span> <span class="string">in</span> <span class="string">StatefulSet</span> <span class="string">web</span> <span class="string">successful</span></span><br><span class="line">  <span class="string">Normal</span>  <span class="string">SuccessfulDelete</span>  <span class="string">26s</span>                  <span class="string">statefulset-controller</span>  <span class="string">delete</span> <span class="string">Pod</span> <span class="string">web-2</span> <span class="string">in</span> <span class="string">StatefulSet</span> <span class="string">web</span> <span class="string">successful</span></span><br><span class="line">  <span class="string">Normal</span>  <span class="string">SuccessfulCreate</span>  <span class="string">19s</span> <span class="string">(x2</span> <span class="string">over</span> <span class="string">4m12s)</span>  <span class="string">statefulset-controller</span>  <span class="string">create</span> <span class="string">Pod</span> <span class="string">web-2</span> <span class="string">in</span> <span class="string">StatefulSet</span> <span class="string">web</span> <span class="string">successful</span></span><br><span class="line"><span class="string">[root@VM-4-3-centos</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> </span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">web-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">5m12s</span></span><br><span class="line"><span class="string">web-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m36s</span></span><br><span class="line"><span class="string">web-2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">23s</span></span><br></pre></td></tr></table></figure><br>可以发现，只有大于等于分区需要才会被更新，这里也只有web-2被更新<p></p><h2 id="强制回滚"><a href="#强制回滚" class="headerlink" title="强制回滚"></a>强制回滚</h2><p>在默认 Pod 管理策略(OrderedReady) 时使用 滚动更新 ，可能进入需要人工干预才能修复的损坏状态。</p><p>如果更新后 Pod 模板配置进入无法运行或就绪的状态（例如，由于错误的二进制文件或应用程序级配置错误），StatefulSet 将停止回滚并等待。</p><p>在这种状态下，仅将 Pod 模板还原为正确的配置是不够的。由于 已知问题，StatefulSet 将继续等待损坏状态的 Pod 准备就绪（永远不会发生），然后再尝试将其恢复为正常工作配置。</p><p>恢复模板后，还必须删除 StatefulSet 尝试使用错误的配置来运行的 Pod。这样， StatefulSet 才会开始使用被还原的模板来重新创建 Pod</p><p>我们日常在更新镜像的时候，发现服务启动失败了，然后将镜像回滚成之前的版本，这样仅仅是不够的，因为StatefulSet 还会一直等待新更新的pod状态ready，但是这个永远不会发生，所以为了恢复正常，我们需要删除更新启动失败的pod。</p><p>下面我们来测试下，我们将pod修改成k8s.gcr.io/nginx-slim:0.8，节点上无法拉取这个镜像的，所以web-2这个pod会一直启动失败。<br></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-4</span><span class="number">-3</span>-centos ~]# kubectl <span class="keyword">get</span> pod </span><br><span class="line">NAME    READY   STATUS             RESTARTS   AGE</span><br><span class="line">web<span class="number">-0</span>   <span class="number">1</span>/<span class="number">1</span>     Running            <span class="number">0</span>          <span class="number">13</span>m</span><br><span class="line">web<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>     Running            <span class="number">0</span>          <span class="number">12</span>m</span><br><span class="line">web<span class="number">-2</span>   <span class="number">0</span>/<span class="number">1</span>     ImagePullBackOff   <span class="number">0</span>          <span class="number">44</span>s</span><br><span class="line">下面我们将镜像改成之前的nginx:<span class="number">1.17</span>，看看会不会恢复</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  podManagementPolicy: OrderedReady</span><br><span class="line">  replicas: <span class="number">3</span></span><br><span class="line">  revisionHistoryLimit: <span class="number">10</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: <span class="literal">null</span></span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:<span class="number">1.17</span></span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-4</span><span class="number">-3</span>-centos ~]# kubectl <span class="keyword">get</span> pod </span><br><span class="line">NAME    READY   STATUS         RESTARTS   AGE</span><br><span class="line">web<span class="number">-0</span>   <span class="number">1</span>/<span class="number">1</span>     Running        <span class="number">0</span>          <span class="number">15</span>m</span><br><span class="line">web<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>     Running        <span class="number">0</span>          <span class="number">14</span>m</span><br><span class="line">web<span class="number">-2</span>   <span class="number">0</span>/<span class="number">1</span>     ErrImagePull   <span class="number">0</span>          <span class="number">2</span>m52s</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-4</span><span class="number">-3</span>-centos ~]# kubectl delete pod web<span class="number">-2</span> </span><br><span class="line">pod <span class="string">"web-2"</span> deleted</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-4</span><span class="number">-3</span>-centos ~]# kubectl <span class="keyword">get</span> pod </span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web<span class="number">-0</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">14</span>s</span><br><span class="line">web<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">33</span>s</span><br><span class="line">web<span class="number">-2</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">45</span>s</span><br></pre></td></tr></table></figure><br>从上面的结果可以看出，我们不删除web-2这个更新异常的pod，所以的pod都不会更新的，只有删除了web-2这个更新失败的pod，sts才会进行正常更新。<p></p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/#deployment-and-scaling-guarantees" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/#deployment-and-scaling-guarantees</a></p><hr><ul class="pager"><li class="previous"><a href="/2020/11/01/kubewatch-monitors-k8s-cluster-resource-changes/" data-toggle="tooltip" data-placement="top" title="kubewatch监控k8s集群资源变更">&larr; Previous Post</a></li><li class="next"><a href="/2020/10/14/Force-delete-Terminating-ns/" data-toggle="tooltip" data-placement="top" title="Kubernetes强制删除Terminating的ns">Next Post &rarr;</a></li></ul><div class="comment_notes_blank"></div><div class="visitor_notice"><img src="/img/notice.png" alt="notice" title="notice"><p class="notice">欢迎访问 <a href="https://www.niewx.cn" target="Vashon">Vashon</a> 的博客，博客和文章在完善中，请大家耐心等待。 若有问题或者有好的建议欢迎留言，笔者看到之后会及时回复。</p></div><div class="comment_notes"><p></p></div><div class="social-share" data-wechat-qrcode-helper="" align="center"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script><hr><div id="lv-container" data-id="city" data-uid="MTAyMC80NzQ3MS8yMzk3MQ=="><script type="text/javascript">!function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((t=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",t.async=!0,n.parentNode.insertBefore(t,n))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#什么是StatefulSet"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">什么是StatefulSet</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#pod的标识符"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">pod的标识符</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#稳定的存储"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">稳定的存储</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Pod-名称标签"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Pod 名称标签</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#StatefulSet的创建和扩缩容"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">StatefulSet的创建和扩缩容</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#StatefulSet的更新"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">StatefulSet的更新</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#RollingUpdate更新"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">RollingUpdate更新</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#OnDelete-更新"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">OnDelete 更新</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#分区更新"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">分区更新</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#强制回滚"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">强制回滚</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#参考文档"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">参考文档</span></a></li></ol></div></aside><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://cloud.tencent.com/developer/column/87421" target="_blank">云+社区文档</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">运维操作宝典</a></li><li><a href="https://www.niewx.cn/question/" target="_blank">运维问题集锦</a></li><li><a href="https://github.com/nieweixing" target="_blank">Github</a></li></ul></div></div></div></article><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style type="text/css">@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://twitter.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.facebook.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/ke-wang-mian-bao-de-you-xia"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 聂伟星 2022<br>Powered by <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener"><i>hexo-theme-snail</i></a><br><script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1280387863'%3E%3C/span%3E%3Cscript src='https://s9.cnzz.com/z_stat.php%3Fid%3D1280387863%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script><br><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("05/10/2020 12:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="  本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script></p></div></div></div></footer><script src="../../../../js/jquery.min.js"></script><script src="../../../../js/bootstrap.min.js"></script><script src="../../../../js/hux-blog.min.js"></script><script src="../../../../js/search.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>0!==$("#tag_cloud").length&&async("https://www.niewx.cn/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="bfe4709ccd8c5c9e559c89f4fd0866f3",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><script type="text/javascript">var search_path="search.xml",path="/"+(search_path=0==search_path.length?"search.xml":search_path);searchFunc(path,"local-search-input","local-search-result")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><a id="rocket" href="#top" class=""></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/mouse-click.js" content="[&quot;🌱&quot;,&quot;just do it&quot;,&quot;🍀&quot;]" color="[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]"></script><script src="/js/ribbonDynamic.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!0},react:{opacity:.7}})</script></body></html>