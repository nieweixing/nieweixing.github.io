<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="VashonNie"><meta name="keywords" content=""><meta name="description" content="etcd是CoreOS团队于2013年6月发起的开源项目，它的目标是构建一个高可用的分布式键值(key-value)数据库。etcd内部采用raft协议作为一致性算法，etcd基于Go语言实现。 etcd作为服务发现系统，有以下的特点：  简单：安装配置简单，而且提供了HTTP API进行交互，使用也很简单 安全：支持SSL证书验证 快速：根据官方提供的benchmark数据，单实例支持每秒2k+"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes之etcd数据库"><meta property="og:url" content="https://www.niewx.cn/2020/11/19/2020-11-19-Etcd-database-of-Kubernetes/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="etcd是CoreOS团队于2013年6月发起的开源项目，它的目标是构建一个高可用的分布式键值(key-value)数据库。etcd内部采用raft协议作为一致性算法，etcd基于Go语言实现。 etcd作为服务发现系统，有以下的特点：  简单：安装配置简单，而且提供了HTTP API进行交互，使用也很简单 安全：支持SSL证书验证 快速：根据官方提供的benchmark数据，单实例支持每秒2k+"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.niewx.cn/img/2020-11-19-Etcd-database-of-Kubernetes/snail-bg.jpg"><meta property="article:published_time" content="2020-11-19T06:10:00.000Z"><meta property="article:modified_time" content="2020-11-19T06:10:00.000Z"><meta property="article:author" content="VashonNie"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="etcd"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.niewx.cn/img/2020-11-19-Etcd-database-of-Kubernetes/snail-bg.jpg"><title>Kubernetes之etcd数据库 - Hexo</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/shubiao.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/gradient.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.niewx.cn",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"bfe4709ccd8c5c9e559c89f4fd0866f3",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"XirY0sfpYd0HU4g4MjKSR39K-gzGzoHsz",app_key:"TuwIbmst7Q1N12V1EgEfVgDm",server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>聂伟星</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><iframe width="350" scrolling="no" height="20" frameborder="0" allowtransparency="true" src="https://i.tianqi.com?c=code&id=40&color=%23FFFFFF&icon=1&site=12"></iframe><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文档</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="https://www.niewx.cn/mybook/"><i class="iconfont icon-notebook"></i> 运维笔记 </a><a class="dropdown-item" target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/column/87421"><i class="iconfont icon-addrbook"></i> 云+社区文档 </a><a class="dropdown-item" href="https://www.niewx.cn/question/"><i class="iconfont icon-notebook"></i> 运维问题集锦</a></div></li><li class="nav-item"><a class="nav-link" href="/playlist/"><i class="iconfont icon-music"></i> 音乐</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-douban-fill"></i> 豆瓣</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/books"><i class="iconfont icon-book"></i> 书籍 </a><a class="dropdown-item" href="/movies"><i class="iconfont icon-youtube-fill"></i> 电影 </a><a class="dropdown-item" href="/games"><i class="iconfont icon-switch-fill"></i> 游戏</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Kubernetes之etcd数据库"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> VashonNie </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-11-19 14:10" pubdate>2020年11月19日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i>28k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i>235 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Kubernetes之etcd数据库</h1><div class="markdown-body"><p>etcd是CoreOS团队于2013年6月发起的开源项目，它的目标是构建一个高可用的分布式键值(key-value)数据库。etcd内部采用raft协议作为一致性算法，etcd基于Go语言实现。</p><p>etcd作为服务发现系统，有以下的特点：</p><ul><li>简单：安装配置简单，而且提供了HTTP API进行交互，使用也很简单</li><li>安全：支持SSL证书验证</li><li>快速：根据官方提供的benchmark数据，单实例支持每秒2k+读操作</li><li>可靠：采用raft算法，实现分布式系统数据的可用性和一致性</li></ul><p>由于上面的特点和优势，etcd也被作为k8s默认的存储数据库，今天我们来讲一讲如何部署etcd数据库集群以及etcd的一些常见使用方法。</p><h1 id="Docker-compose搭建etcd集群"><a href="#Docker-compose搭建etcd集群" class="headerlink" title="Docker-compose搭建etcd集群"></a>Docker-compose搭建etcd集群</h1><p>编写docker-compose.yml文件，具体内容如下</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">version</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><span class="hljs-attribute">networks</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">byfn</span><span class="hljs-punctuation">:</span><br><span class="hljs-punctuation"></span><br><span class="hljs-attribute">services</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">etcd1</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">quay.io/coreos/etcd</span><br>    <span class="hljs-attribute">container_name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd1</span><br>    <span class="hljs-attribute">command</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd -name etcd1 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br>    <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2379</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2380</span><br>    <span class="hljs-attribute">networks</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br> <br>  <span class="hljs-attribute">etcd2</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">quay.io/coreos/etcd</span><br>    <span class="hljs-attribute">container_name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd2</span><br>    <span class="hljs-attribute">command</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd -name etcd2 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br>    <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2379</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2380</span><br>    <span class="hljs-attribute">networks</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br>  <br>  <span class="hljs-attribute">etcd3</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">quay.io/coreos/etcd</span><br>    <span class="hljs-attribute">container_name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd3</span><br>    <span class="hljs-attribute">command</span><span class="hljs-punctuation">:</span> <span class="hljs-string">etcd -name etcd3 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br>    <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2379</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">2380</span><br>    <span class="hljs-attribute">networks</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br></code></pre></td></tr></table></figure><p>参数介绍：</p><ul><li>data-dir 指定节点的数据存储目录，这些数据包括节点ID，集群ID，集群初始化配置，</li><li>Snapshot文件，若未指定—wal-dir，还会存储WAL文件；</li><li>wal-dir 指定节点的was文件的存储目录，若指定了该参数，wal文件会和其他数据文件分开存储。</li><li>name 节点名称</li><li>initial-advertise-peer-urls 告知集群其他节点url.</li><li>listen-peer-urls 监听URL，用于与其他节点通讯</li><li>advertise-client-urls 告知客户端url, 也就是服务的url</li><li>initial-cluster-token 集群的ID</li><li>initial-cluster 集群中所有节点</li><li>initial-cluster-state 监听客户端状态</li><li>listen-client-urls 监听客户端地址</li><li>initial-cluster-state new 初始化集群 为新节点</li></ul><p>然后docker-compose运行etcd的yaml文件，并且插入数据进行检查验证</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@VM-<span class="hljs-number">0</span>-<span class="hljs-number">13</span>-centos docker-compose]<span class="hljs-comment"># docker-compose up -d</span><br><span class="hljs-regexp">//</span>查看集群节点状态<br>[root@VM-<span class="hljs-number">0</span>-<span class="hljs-number">13</span>-centos docker-compose]<span class="hljs-comment"># etcdctl --endpoints 127.0.0.1:32771 member list</span><br>ade526d28b1f92f7, started, etcd1, http:<span class="hljs-regexp">//</span>etcd1:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">2379</span>, false<br>bd388e7810915853, started, etcd3, http:<span class="hljs-regexp">//</span>etcd3:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">2379</span>, false<br>d282ac2ce600c1ce, started, etcd2, http:<span class="hljs-regexp">//</span>etcd2:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">2379</span>, false<br><span class="hljs-regexp">//</span>给etcd1节点插入数据<br>[root@VM-<span class="hljs-number">0</span>-<span class="hljs-number">13</span>-centos docker-compose]<span class="hljs-comment"># curl -L http://127.0.0.1:32771/v2/keys/etcd -XPUT -d value=&quot;Hello etcd1&quot;</span><br>&#123;<span class="hljs-string">&quot;action&quot;</span>:<span class="hljs-string">&quot;set&quot;</span>,<span class="hljs-string">&quot;node&quot;</span>:&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;/etcd&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;Hello etcd1&quot;</span>,<span class="hljs-string">&quot;modifiedIndex&quot;</span>:<span class="hljs-number">8</span>,<span class="hljs-string">&quot;createdIndex&quot;</span>:<span class="hljs-number">8</span>&#125;&#125;<br><span class="hljs-regexp">//</span>检查在etcd2中是否能够查到<br>[root@VM-<span class="hljs-number">0</span>-<span class="hljs-number">13</span>-centos docker-compose]<span class="hljs-comment"># curl -L http://127.0.0.1:32773/v2/keys/etcd</span><br>&#123;<span class="hljs-string">&quot;action&quot;</span>:<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;node&quot;</span>:&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;/etcd&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;Hello etcd1&quot;</span>,<span class="hljs-string">&quot;modifiedIndex&quot;</span>:<span class="hljs-number">8</span>,<span class="hljs-string">&quot;createdIndex&quot;</span>:<span class="hljs-number">8</span>&#125;&#125;<br><span class="hljs-regexp">//</span>检查在etcd3中是否能够查到<br>[root@VM-<span class="hljs-number">0</span>-<span class="hljs-number">13</span>-centos docker-compose]<span class="hljs-comment"># curl -L http://127.0.0.1:32769/v2/keys/etcd</span><br>&#123;<span class="hljs-string">&quot;action&quot;</span>:<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;node&quot;</span>:&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;/etcd&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;Hello etcd1&quot;</span>,<span class="hljs-string">&quot;modifiedIndex&quot;</span>:<span class="hljs-number">8</span>,<span class="hljs-string">&quot;createdIndex&quot;</span>:<span class="hljs-number">8</span>&#125;&#125;<br></code></pre></td></tr></table></figure><h1 id="二进制部署etcd集群"><a href="#二进制部署etcd集群" class="headerlink" title="二进制部署etcd集群"></a>二进制部署etcd集群</h1><p>这个可以参考之前的文章 二进制搭建k8s集群 <a href="https://www.niewx.cn/kubernetes/docker/2020/09/20/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2k8s/">https://www.niewx.cn/kubernetes/docker/2020/09/20/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2k8s/</a></p><p>其中部署etcd集群章节有说明如何搭建</p><h1 id="kubeadm集群如何使用etcd集群"><a href="#kubeadm集群如何使用etcd集群" class="headerlink" title="kubeadm集群如何使用etcd集群"></a>kubeadm集群如何使用etcd集群</h1><p>一般我们如果通过kubeadm创建的集群都是单节点的etcd，那么如何配置一个高可用的etcd集群给kubeadm的集群。首先你需要通过kubeadm搭建一个集群，你可以参考文章进行部署<a href="https://www.niewx.cn/kubernetes/docker/2020/09/15/kubeadm%E9%83%A8%E7%BD%B2k8s/">https://www.niewx.cn/kubernetes/docker/2020/09/15/kubeadm%E9%83%A8%E7%BD%B2k8s/</a></p><p>也可以通过<a href="https://www.niewx.cn/kubernetes/docker/2020/05/10/k8s%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/">https://www.niewx.cn/kubernetes/docker/2020/05/10/k8s%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/</a> 一键部署包进行安装，这里就不细说了</p><p>集群部署好之后，我们下面来部署etcd集群，并接入对应的集群中，大致步骤如下</p><ul><li>新建一个 2 节点的 etcd cluster</li><li>查看 etcd 的状态</li><li>迁移原来 master 节点上的 etcd 数据到上面新建的 etcd cluster 中</li><li>切换 kube-apiserver 使用新的 etcd endpoint 地址</li><li>清理掉原来的单节点 etcd 服务</li><li>重建一个 etcd 服务，加入新集群</li><li>部署新的 etcd 节点</li><li>更新另外2个节点的 etcd.yaml 配置</li></ul><h2 id="新建一个2节点的-etcd-cluster"><a href="#新建一个2节点的-etcd-cluster" class="headerlink" title="新建一个2节点的 etcd cluster"></a>新建一个2节点的 etcd cluster</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">//基于当前 master 节点 tvm-00 的 etcd 配置来修改：</span><br>[root@tvm-<span class="hljs-number">00</span> ~]# scp <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span>etcd.yaml <span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-regexp">/tmp/</span><br>[root@tvm-<span class="hljs-number">00</span> ~]# scp <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span>etcd.yaml <span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-regexp">/tmp/</span><br><span class="hljs-comment">//修改 etcd 配置，设置成一个全新的 cluster</span><br>[root@tvm-<span class="hljs-number">01</span> ~]# cat <span class="hljs-regexp">/tmp/</span>etcd.yaml <span class="hljs-comment">// (略过部分没有改动的输出内容)</span><br>spec:<br> containers:<br> - command:<br> - etcd<br> - --name=etcd-<span class="hljs-number">01</span><br> - --initial-advertise-peer-urls=http:<span class="hljs-comment">//10.10.9.68:2380</span><br> - --listen-peer-urls=http:<span class="hljs-comment">//10.10.9.68:2380</span><br> - --listen-client-urls=http:<span class="hljs-comment">//127.0.0.1:2379,http://10.10.9.68:2379</span><br> - --advertise-client-urls=http:<span class="hljs-comment">//10.10.9.68:2379</span><br> - --initial-cluster-token=etcd-cluster<br> - --initial-cluster=etcd-<span class="hljs-number">01</span>=http:<span class="hljs-comment">//10.10.9.68:2380,etcd-02=http://10.10.9.69:2380</span><br> - --initial-cluster-state=<span class="hljs-keyword">new</span><br> - --data-dir=<span class="hljs-regexp">/var/</span>lib/etcd<br> image: gcr.io<span class="hljs-regexp">/google_containers/</span>etcd-amd64:<span class="hljs-number">3.1</span>.<span class="hljs-number">10</span> <span class="hljs-comment">// (略过部分没有改动的输出内容)</span><br>[root@tvm-<span class="hljs-number">02</span> ~]# cat <span class="hljs-regexp">/tmp/</span>etcd.yaml <span class="hljs-comment">// (略过部分没有改动的输出内容)</span><br>spec:<br> containers:<br> - command:<br> - etcd<br> - --name=etcd-<span class="hljs-number">02</span><br> - --initial-advertise-peer-urls=http:<span class="hljs-comment">//10.10.9.69:2380</span><br> - --listen-peer-urls=http:<span class="hljs-comment">//10.10.9.69:2380</span><br> - --listen-client-urls=http:<span class="hljs-comment">//127.0.0.1:2379,http://10.10.9.69:2379</span><br> - --advertise-client-urls=http:<span class="hljs-comment">//10.10.9.69:2379</span><br> - --initial-cluster-token=etcd-cluster<br> - --initial-cluster=etcd-<span class="hljs-number">01</span>=http:<span class="hljs-comment">//10.10.9.68:2380,etcd-02=http://10.10.9.69:2380</span><br> - --initial-cluster-state=<span class="hljs-keyword">new</span><br> - --data-dir=<span class="hljs-regexp">/var/</span>lib/etcd<br> image: gcr.io<span class="hljs-regexp">/google_containers/</span>etcd-amd64:<span class="hljs-number">3.1</span>.<span class="hljs-number">10</span> <span class="hljs-comment">//(略过部分没有改动的输出内容)</span><br><span class="hljs-comment">//启动 etcd cluster### 配置文件同步到 manifests 后将会被 kubelet 检测到然后自动将 pod 启动</span><br>[root@tvm-<span class="hljs-number">01</span> ~]# rm <span class="hljs-regexp">/var/</span>lib/etcd -fr<br>[root@tvm-<span class="hljs-number">01</span> ~]# cp -a <span class="hljs-regexp">/tmp/</span>etcd.yaml <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span><br>[root@tvm-<span class="hljs-number">02</span> ~]# rm <span class="hljs-regexp">/var/</span>lib/etcd -fr<br>[root@tvm-<span class="hljs-number">02</span> ~]# cp -a <span class="hljs-regexp">/tmp/</span>etcd.yaml <span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span><br></code></pre></td></tr></table></figure><h2 id="查看-etcd-的状态"><a href="#查看-etcd-的状态" class="headerlink" title="查看 etcd 的状态"></a>查看 etcd 的状态</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>下载一个 etcdctl 工具来管理集群：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># cd /usr/local/bin/</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># wget </span><br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/coreos/</span>etcd<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v3.1.10/</span>etcd-v3.<span class="hljs-number">1.10</span>-linux-amd64.tar.gz<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># tar zxf etcd-v3.1.10-linux-amd64.tar.gz</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># mv etcd-v3.1.10-linux-amd64/etcd* .</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints</span><br> <span class="hljs-string">&quot;http://10.10.9.68:2379,http://10.10.9.69:2379&quot;</span> endpoint status<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">21</span>b9c7066a7e525, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">25</span> kB, true, <span class="hljs-number">7</span>, <span class="hljs-number">194</span><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">516</span>e519b2158e83a, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">25</span> kB, false, <span class="hljs-number">7</span>, <span class="hljs-number">194</span><br><span class="hljs-regexp">//</span>注意：输出的列从左到右分别表示：endpoint URL, ID, version, database size, leadership status, raft term, and raft status.<span class="hljs-comment">### 符合预期。</span><br></code></pre></td></tr></table></figure><h2 id="迁移原来-master-节点上的-etcd-数据到上面新建的-etcd-cluster-中"><a href="#迁移原来-master-节点上的-etcd-数据到上面新建的-etcd-cluster-中" class="headerlink" title="迁移原来 master 节点上的 etcd 数据到上面新建的 etcd cluster 中"></a>迁移原来 master 节点上的 etcd 数据到上面新建的 etcd cluster 中</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>注意：etcdctl <span class="hljs-number">3</span>.x 版本提供了一个 make-mirror 功能来同步数据<span class="hljs-comment">### 在当前 master 节点 </span><br>tvm-<span class="hljs-number">00</span> 上执行：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl make-mirror --no-dest-prefix=true </span><br>--endpoints=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> --insecure-skip-tls-verify=true <span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span><br><span class="hljs-regexp">//</span>将数据同步到远端刚才新建的 etcd 集群中<span class="hljs-comment">### 注意1：数据是从 127.0.0.1:2379 写入到 10.10.9.68:2379### 注意2：这个同步只能是手动中止，间隔 30s 打印一次输出</span><br><span class="hljs-regexp">//</span>通过对比集群到状态来判断是否同步完成：<span class="hljs-comment">###（新开一个窗口）</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl endpoint status</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">8</span>e9e05c52164694d, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">1.9</span> MB, true, <span class="hljs-number">2</span>, <span class="hljs-number">342021</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints </span><br><span class="hljs-string">&quot;http://10.10.9.68:2379,http://10.10.9.69:2379&quot;</span> endpoint status<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">21</span>b9c7066a7e525, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">1.9</span> MB, true, <span class="hljs-number">7</span>, <span class="hljs-number">1794</span><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">516</span>e519b2158e83a, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">1.9</span> MB, false, <span class="hljs-number">7</span>, <span class="hljs-number">1794</span><br></code></pre></td></tr></table></figure><h2 id="切换-kube-apiserver-使用新的-etcd-endpoint-地址"><a href="#切换-kube-apiserver-使用新的-etcd-endpoint-地址" class="headerlink" title="切换 kube-apiserver 使用新的 etcd endpoint 地址"></a>切换 kube-apiserver 使用新的 etcd endpoint 地址</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>停止 kubelet 服务：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># systemctl stop kubelet</span><br><span class="hljs-regexp">//</span>更新 kube-apiserver.yaml 中 etcd 服务到地址，切到我们到新集群中：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># sed -i &#x27;s#127.0.0.1:2379#10.10.9.68:2379#&#x27; </span><br><span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span>kube-apiserver.yaml<br><span class="hljs-regexp">//</span>启动 kubelet 服务：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># systemctl start kubelet</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># kubectl get pods --all-namespaces |grep &#x27;etcd-tvm&#x27;</span><br>kube-system etcd-tvm-<span class="hljs-number">00</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">1</span> <span class="hljs-number">4</span>h<br>kube-system etcd-tvm-<span class="hljs-number">01</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br>kube-system etcd-tvm-<span class="hljs-number">02</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br></code></pre></td></tr></table></figure><h2 id="清理掉原来的单节点-etcd-服务"><a href="#清理掉原来的单节点-etcd-服务" class="headerlink" title="清理掉原来的单节点 etcd 服务"></a>清理掉原来的单节点 etcd 服务</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># mv /etc/kubernetes/manifests/etcd.yaml /tmp/orig.master.etcd.yaml</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># mv /var/lib/etcd /tmp/orig.master.etcd // 观察 pods 的变化：</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># kubectl get pods --all-namespaces |grep &#x27;etcd-tvm&#x27;</span><br>kube-<span class="hljs-keyword">system</span> etcd-tvm-<span class="hljs-number">01</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br>kube-<span class="hljs-keyword">system</span> etcd-tvm-<span class="hljs-number">02</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br>//符合预期 etcd-tvm-<span class="hljs-number">00</span> 停止服务<br></code></pre></td></tr></table></figure><h2 id="重建一个-etcd-服务，加入新集群"><a href="#重建一个-etcd-服务，加入新集群" class="headerlink" title="重建一个 etcd 服务，加入新集群"></a>重建一个 etcd 服务，加入新集群</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># cat /tmp/etcd.yaml //(略过部分没有改动的输出内容)</span><br>spec:<br> containers:<br> - command:<br> - etcd<br> - --name=etcd-<span class="hljs-number">00</span><br> - --initial-advertise-peer-urls=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span><br> - --listen-peer-urls=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span><br> - --listen-client-urls=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2379</span><br> - --advertise-client-urls=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2379</span><br> - --initial-cluster-token=etcd-cluster<br>- --initial-cluster=etcd-<span class="hljs-number">00</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span>,etcd-<span class="hljs-number">01</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2380</span>,etcd-<span class="hljs-number">02</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2380</span><br> - --initial-cluster-state=existing<br> - --data-dir=<span class="hljs-regexp">/var/</span>lib/etcd<br> image: gcr.io<span class="hljs-regexp">/google_containers/</span>etcd-amd64:<span class="hljs-number">3.1</span>.<span class="hljs-number">10</span> <span class="hljs-regexp">//</span>(略过部分没有改动的输出内容)<br><span class="hljs-regexp">//</span>注意：上述新节点的配置有一个地方不一样：<br>--initial-cluster-state=existing<br></code></pre></td></tr></table></figure><h2 id="先配置-etcd-cluster-增加一个-member-用于后续操作"><a href="#先配置-etcd-cluster-增加一个-member-用于后续操作" class="headerlink" title="先配置 etcd cluster 增加一个 member 用于后续操作"></a>先配置 etcd cluster 增加一个 member 用于后续操作</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints=&quot;http://10.10.9.68:2379&quot; member list</span><br><span class="hljs-number">21</span>b9c7066a7e525, started, etcd-<span class="hljs-number">01</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span><br><span class="hljs-number">516</span>e519b2158e83a, started, etcd-<span class="hljs-number">02</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints=&quot;http://10.10.9.68:2379&quot; member add etcd-00 --peer-urls=http://10.10.9.67:2380</span><br> Member <span class="hljs-number">6</span>cc2e7728adb6b28 added to cluster <span class="hljs-number">3742</span>ed98339167da<br>ETCD_NAME=<span class="hljs-string">&quot;etcd-00&quot;</span><br> ETCD_INITIAL_CLUSTER=<span class="hljs-string">&quot;etcd-01=http://10.10.9.68:2380,etcd-02=http://10.10.9.69:2380,etcd-00=http://10.10.9.67:2380&quot;</span><br> ETCD_INITIAL_CLUSTER_STATE=<span class="hljs-string">&quot;existing&quot;</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints=&quot;http://10.10.9.68:2379&quot; member list</span><br> <span class="hljs-number">21</span>b9c7066a7e525, started, etcd-<span class="hljs-number">01</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span><br> <span class="hljs-number">516</span>e519b2158e83a, started, etcd-<span class="hljs-number">02</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span><br> <span class="hljs-number">6</span>cc2e7728adb6b28, unstarted, , http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span>,<br><span class="hljs-regexp">//</span>部署新的 etcd 节点<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># rm /var/lib/etcd -fr</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># cp -a /tmp/etcd.yaml /etc/kubernetes/manifests/</span><br><span class="hljs-regexp">//</span>再次查看 k8s cluster 信息<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># kubectl get pods --all-namespaces |grep &#x27;etcd-tvm&#x27;</span><br>kube-system etcd-tvm-<span class="hljs-number">00</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">1</span> <span class="hljs-number">4</span>h<br>kube-system etcd-tvm-<span class="hljs-number">01</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br>kube-system etcd-tvm-<span class="hljs-number">02</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>h<br><span class="hljs-regexp">//</span>etcd 的日志：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># kubectl logs -n kube-system --tail=20 etcd-tvm-00</span><br><span class="hljs-regexp">//</span>etcd clister 状态：<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl </span><br>--endpoints=<span class="hljs-string">&quot;http://10.10.9.67:2379,http://10.10.9.68:2379,http://10.10.9.69:2379&quot;</span> member List<br><span class="hljs-number">21</span>b9c7066a7e525, started, etcd-<span class="hljs-number">01</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span><br><span class="hljs-number">516</span>e519b2158e83a, started, etcd-<span class="hljs-number">02</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span><br><span class="hljs-number">6</span>cc2e7728adb6b28, started, etcd-<span class="hljs-number">00</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span>, http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2379</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># ETCDCTL_API=3 etcdctl --endpoints</span><br><span class="hljs-string">&quot;http://10.10.9.67:2379,http://10.10.9.68:2379,http://10.10.9.69:2379&quot;</span> endpoint status<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">6</span>cc2e7728adb6b28, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">3.8</span> MB, false, <span class="hljs-number">7</span>, <span class="hljs-number">5236</span><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">21</span>b9c7066a7e525, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">3.3</span> MB, true, <span class="hljs-number">7</span>, <span class="hljs-number">5236</span><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2379</span>, <span class="hljs-number">516</span>e519b2158e83a, <span class="hljs-number">3.1</span>.<span class="hljs-number">10</span>, <span class="hljs-number">3.3</span> MB, false, <span class="hljs-number">7</span>, <span class="hljs-number">5236</span><br></code></pre></td></tr></table></figure><h2 id="更新另外2个节点的-etcd-yaml-配置"><a href="#更新另外2个节点的-etcd-yaml-配置" class="headerlink" title="更新另外2个节点的 etcd.yaml 配置"></a>更新另外2个节点的 etcd.yaml 配置</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>区别之处：<br>- --initial-cluster=etcd-<span class="hljs-number">00</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.67</span>:<span class="hljs-number">2380</span>,etcd-<span class="hljs-number">01</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.68</span>:<span class="hljs-number">2380</span>,etcd-<span class="hljs-number">02</span>=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.10</span>.<span class="hljs-number">9.69</span>:<span class="hljs-number">2380</span><br>- --initial-cluster-state=existing<br><span class="hljs-regexp">//</span>将节点 tvm-<span class="hljs-number">00</span> 上 kube-apiserver 使用的 etcd endpoint 切换回来<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># sed -i &#x27;s#10.10.9.68:2379#127.0.0.1:2379#&#x27; </span><br><span class="hljs-regexp">/etc/</span>kubernetes<span class="hljs-regexp">/manifests/</span>kube-apiserver.yaml<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># kubectl get pods --all-namespaces |grep api</span><br>kube-system kube-apiserver-tvm-<span class="hljs-number">00</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span> Running <span class="hljs-number">0</span> <span class="hljs-number">1</span>m<br></code></pre></td></tr></table></figure><h2 id="kubeadm使用已有etcd集群"><a href="#kubeadm使用已有etcd集群" class="headerlink" title="kubeadm使用已有etcd集群"></a>kubeadm使用已有etcd集群</h2><p>假如我们已经提前搭建好了一个etcd集群，那么在kubeadm进行部署的时候如何去使用这个集群，其实只需要在kubeadm中进行配置即可</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dts">cat <span class="hljs-params">&lt;&lt;EOF &gt;</span> <span class="hljs-keyword">/etc/</span>kubernetes/kubeadm-config.yaml<br><span class="hljs-symbol">apiVersion:</span> kubeadm.k8s.io/v1beta1<br><span class="hljs-symbol">kind:</span> ClusterConfiguration<br><span class="hljs-symbol">kubernetesVersion:</span> v1<span class="hljs-number">.13</span><span class="hljs-number">.0</span><br><span class="hljs-symbol">apiServer:</span><br><span class="hljs-symbol"> certSANs:</span><br> - <span class="hljs-number">10.127</span><span class="hljs-number">.24</span><span class="hljs-number">.179</span><br> - <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br><span class="hljs-symbol">networking:</span><br><span class="hljs-symbol"> podSubnet:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">16</span><br><span class="hljs-symbol">etcd:</span><br><span class="hljs-symbol"> external:</span><br><span class="hljs-symbol"> endpoints:</span><br> - https:<span class="hljs-comment">//10.39.14.204:2379</span><br> - https:<span class="hljs-comment">//10.39.14.205:2379</span><br> - https:<span class="hljs-comment">//10.39.14.206:2379</span><br><span class="hljs-symbol"> caFile:</span> <span class="hljs-keyword">/etc/</span>kubernetes<span class="hljs-keyword">/pki/</span>etcd/ca.crt<br><span class="hljs-symbol"> certFile:</span> <span class="hljs-keyword">/etc/</span>kubernetes<span class="hljs-keyword">/pki/</span>apiserver-etcd-client.crt<br><span class="hljs-symbol"> keyFile:</span> <span class="hljs-keyword">/etc/</span>kubernetes<span class="hljs-keyword">/pki/</span>apiserver-etcd-client.key<br>EOF<br></code></pre></td></tr></table></figure><h1 id="如何在k8s中搭建etcd集群"><a href="#如何在k8s中搭建etcd集群" class="headerlink" title="如何在k8s中搭建etcd集群"></a>如何在k8s中搭建etcd集群</h1><p>这里我们可以使用 StatefulSet 这个控制器来运行 etcd 集群，etcd 集群的编排的资源清单文件我们可以使用 Kubernetes 源码中提供的，位于目录：test&#x2F;e2e&#x2F;testing-manifests&#x2F;statefulset&#x2F;etcd下面。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">git clone https://github.com/kubernetes/kubernetes<br>cd kubernetes/test/e2e/testing-manifests/statefulset/etcd<br>ll //查看对应的yaml文件如下<br>-rw-r--r--<span class="hljs-number"> 1 </span>nieweixing<span class="hljs-number"> 197121 </span><span class="hljs-number"> 184 </span>11月<span class="hljs-number"> 11 </span>00:10 pdb.yaml<br>-rw-r--r--<span class="hljs-number"> 1 </span>nieweixing<span class="hljs-number"> 197121 </span><span class="hljs-number"> 258 </span>11月<span class="hljs-number"> 11 </span>00:10 service.yaml<br>-rw-r--r--<span class="hljs-number"> 1 </span>nieweixing<span class="hljs-number"> 197121 </span>6619 11月<span class="hljs-number"> 11 </span>00:10 statefulset.yaml<br>-rw-r--r--<span class="hljs-number"> 1 </span>nieweixing<span class="hljs-number"> 197121 </span><span class="hljs-number"> 577 </span>11月<span class="hljs-number"> 11 </span>00:10 tester.yaml<br></code></pre></td></tr></table></figure><p>service.yaml文件中就是一个用户 StatefulSet 使用的 headless service：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">etcd</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">etcd</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">2380</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">etcd-server</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">2379</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">etcd-client</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">etcd</span><br>  <span class="hljs-attr">publishNotReadyAddresses:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>pdb.yaml文件是用来保证 etcd 的高可用的一个 PodDisruptionBudget 资源对象，PodDisruptionBudget<br>说明详情可以参考文档<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/">https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/</a></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> policy/v1beta1<br><span class="hljs-symbol">kind:</span> PodDisruptionBudget<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> etcd-pdb<br><span class="hljs-symbol">  labels:</span><br><span class="hljs-symbol">    pdb:</span> etcd<br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  minAvailable:</span> <span class="hljs-number">2</span><br><span class="hljs-symbol">  selector:</span><br><span class="hljs-symbol">    matchLabels:</span><br><span class="hljs-symbol">      app:</span> etcd<br></code></pre></td></tr></table></figure><p>statefulset.yaml，这里修改下http:&#x2F;&#x2F;${HOSTNAME}.${SET_NAME}成http:&#x2F;&#x2F;${POD_IP}:PORT这样</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: apps/v1<br>kind: StatefulSet<br>metadata:<br>  labels:<br>    app: etcd<br>  name: etcd<br>spec:<br>  replicas: 3<br>  selector:<br>    matchLabels:<br>      app: etcd<br>  serviceName: etcd<br>  template:<br>    metadata:<br>      labels:<br>        app: etcd<br>    spec:<br>      containers:<br>        - name: etcd<br>          image: k8s.gcr.io/etcd:3.2.24<br>          imagePullPolicy: IfNotPresent<br>          ports:<br>          - containerPort: 2380<br>            name: peer<br>            protocol: TCP<br>          - containerPort: 2379<br>            name: client<br>            protocol: TCP<br>          <span class="hljs-built_in">env</span>:<br>          - name: INITIAL_CLUSTER_SIZE<br>            value: <span class="hljs-string">&quot;3&quot;</span><br>          - name: MY_NAMESPACE<br>            valueFrom:<br>              fieldRef:<br>                fieldPath: metadata.namespace<br>          - name: POD_IP<br>            valueFrom:<br>              fieldRef:<br>                fieldPath: status.podIP<br>          - name: SET_NAME<br>            value: <span class="hljs-string">&quot;etcd&quot;</span><br>          <span class="hljs-built_in">command</span>:<br>            - /bin/sh<br>            - -ec<br>            - |<br>              HOSTNAME=$(hostname)<br><br>              ETCDCTL_API=3<br><br>              <span class="hljs-function"><span class="hljs-title">eps</span></span>() &#123;<br>                  EPS=<span class="hljs-string">&quot;&quot;</span><br>                  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 $((<span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> - <span class="hljs-number">1</span>))); <span class="hljs-keyword">do</span><br>                      EPS=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;EPS&#125;</span><span class="hljs-variable">$&#123;EPS:+,&#125;</span>http://<span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2379&quot;</span><br>                  <span class="hljs-keyword">done</span><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;EPS&#125;</span><br>              &#125;<br><br>              <span class="hljs-function"><span class="hljs-title">member_hash</span></span>() &#123;<br>                  etcdctl member list | grep -w <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTNAME</span>&quot;</span> | awk <span class="hljs-string">&#x27;&#123; print $1&#125;&#x27;</span> | awk -F <span class="hljs-string">&quot;,&quot;</span> <span class="hljs-string">&#x27;&#123; print $1&#125;&#x27;</span><br>              &#125;<br><br>              <span class="hljs-function"><span class="hljs-title">initial_peers</span></span>() &#123;<br>                  PEERS=<span class="hljs-string">&quot;&quot;</span><br>                  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 $((<span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> - <span class="hljs-number">1</span>))); <span class="hljs-keyword">do</span><br>                    PEERS=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PEERS&#125;</span><span class="hljs-variable">$&#123;PEERS:+,&#125;</span><span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>=http://<span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2380&quot;</span><br>                  <span class="hljs-keyword">done</span><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;PEERS&#125;</span><br>              &#125;<br><br>              <span class="hljs-comment"># etcd-SET_ID</span><br>              SET_ID=<span class="hljs-variable">$&#123;HOSTNAME##*-&#125;</span><br><br>              <span class="hljs-comment"># adding a new member to existing cluster (assuming all initial pods are available)</span><br>              <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;SET_ID&#125;</span>&quot;</span> -ge <span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> ]; <span class="hljs-keyword">then</span><br>                  <span class="hljs-comment"># export ETCDCTL_ENDPOINTS=$(eps)</span><br>                  <span class="hljs-comment"># member already added?</span><br><br>                  MEMBER_HASH=$(member_hash)<br>                  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MEMBER_HASH&#125;</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>                      <span class="hljs-comment"># the member hash exists but for some reason etcd failed</span><br>                      <span class="hljs-comment"># as the datadir has not be created, we can remove the member</span><br>                      <span class="hljs-comment"># and retrieve new hash</span><br>                      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Remove member <span class="hljs-variable">$&#123;MEMBER_HASH&#125;</span>&quot;</span><br>                      etcdctl --endpoints=$(eps) member remove <span class="hljs-variable">$&#123;MEMBER_HASH&#125;</span><br>                  <span class="hljs-keyword">fi</span><br><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Adding new member&quot;</span><br><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;etcdctl --endpoints=<span class="hljs-subst">$(eps)</span> member add <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> --peer-urls=http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2380&quot;</span><br>                  etcdctl member --endpoints=$(eps) add <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> --peer-urls=http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2380 | grep <span class="hljs-string">&quot;^ETCD_&quot;</span> &gt; /var/run/etcd/new_member_envs<br><br>                  <span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span><br>                      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;member add <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> error.&quot;</span><br>                      <span class="hljs-built_in">rm</span> -f /var/run/etcd/new_member_envs<br>                      <span class="hljs-built_in">exit</span> 1<br>                  <span class="hljs-keyword">fi</span><br><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==&gt; Loading env vars of existing cluster...&quot;</span><br>                  sed -ie <span class="hljs-string">&quot;s/^/export /&quot;</span> /var/run/etcd/new_member_envs<br>                  <span class="hljs-built_in">cat</span> /var/run/etcd/new_member_envs<br>                  . /var/run/etcd/new_member_envs<br><br>                  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;etcd --name <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> --initial-advertise-peer-urls <span class="hljs-variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> --listen-peer-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2380 --listen-client-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2379,http://127.0.0.1:2379 --advertise-client-urls http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2379 --data-dir /var/run/etcd/default.etcd --initial-cluster <span class="hljs-variable">$&#123;ETCD_INITIAL_CLUSTER&#125;</span> --initial-cluster-state <span class="hljs-variable">$&#123;ETCD_INITIAL_CLUSTER_STATE&#125;</span>&quot;</span><br><br>                  <span class="hljs-built_in">exec</span> etcd --listen-peer-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2380 \<br>                      --listen-client-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2379,http://127.0.0.1:2379 \<br>                      --advertise-client-urls http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2379 \<br>                      --data-dir /var/run/etcd/default.etcd<br>              <span class="hljs-keyword">fi</span><br><br>              <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 $((<span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> - <span class="hljs-number">1</span>))); <span class="hljs-keyword">do</span><br>                  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span><br>                      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Waiting for <span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local to come up&quot;</span><br>                      ping -W 1 -c 1 <span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local &gt; /dev/null &amp;&amp; <span class="hljs-built_in">break</span><br>                      <span class="hljs-built_in">sleep</span> 1s<br>                  <span class="hljs-keyword">done</span><br>              <span class="hljs-keyword">done</span><br><br>              <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;join member <span class="hljs-variable">$&#123;HOSTNAME&#125;</span>&quot;</span><br>              <span class="hljs-comment"># join member</span><br>              <span class="hljs-built_in">exec</span> etcd --name <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> \<br>                  --initial-advertise-peer-urls http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2380 \<br>                  --listen-peer-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2380 \<br>                  --listen-client-urls http://<span class="hljs-variable">$&#123;POD_IP&#125;</span>:2379,http://127.0.0.1:2379 \<br>                  --advertise-client-urls http://<span class="hljs-variable">$&#123;HOSTNAME&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2379 \<br>                  --initial-cluster-token etcd-cluster-1 \<br>                  --data-dir /var/run/etcd/default.etcd \<br>                  --initial-cluster $(initial_peers) \<br>                  --initial-cluster-state new<br>          lifecycle:<br>            preStop:<br>              <span class="hljs-built_in">exec</span>:<br>                <span class="hljs-built_in">command</span>:<br>                  - /bin/sh<br>                  - -ec<br>                  - |<br>                    HOSTNAME=$(hostname)<br><br>                    <span class="hljs-function"><span class="hljs-title">member_hash</span></span>() &#123;<br>                        etcdctl member list | grep -w <span class="hljs-string">&quot;<span class="hljs-variable">$HOSTNAME</span>&quot;</span> | awk <span class="hljs-string">&#x27;&#123; print $1&#125;&#x27;</span> | awk -F <span class="hljs-string">&quot;,&quot;</span> <span class="hljs-string">&#x27;&#123; print $1&#125;&#x27;</span><br>                    &#125;<br><br>                    <span class="hljs-function"><span class="hljs-title">eps</span></span>() &#123;<br>                        EPS=<span class="hljs-string">&quot;&quot;</span><br>                        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 $((<span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> - <span class="hljs-number">1</span>))); <span class="hljs-keyword">do</span><br>                            EPS=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;EPS&#125;</span><span class="hljs-variable">$&#123;EPS:+,&#125;</span>http://<span class="hljs-variable">$&#123;SET_NAME&#125;</span>-<span class="hljs-variable">$&#123;i&#125;</span>.<span class="hljs-variable">$&#123;SET_NAME&#125;</span>.<span class="hljs-variable">$&#123;MY_NAMESPACE&#125;</span>.svc.cluster.local:2379&quot;</span><br>                        <span class="hljs-keyword">done</span><br>                        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;EPS&#125;</span><br>                    &#125;<br><br>                    <span class="hljs-built_in">export</span> ETCDCTL_ENDPOINTS=$(eps)<br>                    SET_ID=<span class="hljs-variable">$&#123;HOSTNAME##*-&#125;</span><br><br>                    <span class="hljs-comment"># Removing member from cluster</span><br>                    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;SET_ID&#125;</span>&quot;</span> -ge <span class="hljs-variable">$&#123;INITIAL_CLUSTER_SIZE&#125;</span> ]; <span class="hljs-keyword">then</span><br>                        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Removing <span class="hljs-variable">$&#123;HOSTNAME&#125;</span> from etcd cluster&quot;</span><br>                        etcdctl member remove $(member_hash)<br>                        <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>                            <span class="hljs-comment"># Remove everything otherwise the cluster will no longer scale-up</span><br>                            <span class="hljs-built_in">rm</span> -rf /var/run/etcd/*<br>                        <span class="hljs-keyword">fi</span><br>                    <span class="hljs-keyword">fi</span><br>          volumeMounts:<br>          - mountPath: /var/run/etcd<br>            name: datadir<br>  volumeClaimTemplates:<br>  - metadata:<br>      name: datadir<br>    spec:<br>      accessModes:<br>      - <span class="hljs-string">&quot;ReadWriteOnce&quot;</span><br>      resources:<br>        requests:<br>          <span class="hljs-comment"># upstream recommended max is 700M</span><br>          storage: 10Gi<br></code></pre></td></tr></table></figure><p>执行命令进行部署</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f .<br></code></pre></td></tr></table></figure><p>等pod运行成功后，我们该如何访问呢，这我们给service改成对应的lb类型，这样可以直接通过公网ip个接口就可以访问了</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]# kubectl <span class="hljs-keyword">get</span> svc<br><span class="hljs-type">NAME</span>         <span class="hljs-keyword">TYPE</span>           <span class="hljs-keyword">CLUSTER</span>-IP       <span class="hljs-keyword">EXTERNAL</span>-IP     PORT(S)             AGE<br>etcd         ClusterIP      <span class="hljs-keyword">None</span>             &lt;<span class="hljs-keyword">none</span>&gt;          <span class="hljs-number">2380</span>/TCP,<span class="hljs-number">2379</span>/TCP   <span class="hljs-number">22</span>h<br>etcd-test    LoadBalancer   <span class="hljs-number">172.16</span><span class="hljs-number">.83</span><span class="hljs-number">.34</span>     <span class="hljs-number">106.53</span><span class="hljs-number">.131</span>.xx   <span class="hljs-number">2379</span>:<span class="hljs-number">31354</span>/TCP      <span class="hljs-number">21</span>h<br>kube-<span class="hljs-keyword">user</span>    LoadBalancer   <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.133</span>   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span>        <span class="hljs-number">443</span>:<span class="hljs-number">31745</span>/TCP       <span class="hljs-number">28</span>h<br>kubernetes   ClusterIP      <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>       &lt;<span class="hljs-keyword">none</span>&gt;          <span class="hljs-number">443</span>/TCP             <span class="hljs-number">29</span>h<br></code></pre></td></tr></table></figure><p>这里我们将2379端口通过LoadBalancer 类型的service映射成公网访问了，下面我们来用命令检查下集群。<br>首先下载etcdctl工具，我们登录客户端机器执行下面命令安装etcdctl工具</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># cd /usr/local/bin/</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># wget </span><br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/etcd-io/</span>etcd<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v3.4.13/</span>etcd-v3.<span class="hljs-number">4.13</span>-linux-amd64.tar.gz<br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># tar zxf etcd-v3.4.13-linux-amd64.tar.gz</span><br>[root@tvm-<span class="hljs-number">00</span> ~]<span class="hljs-comment"># mv etcd-v3.4.13-linux-amd64/etcd* .</span><br></code></pre></td></tr></table></figure><p>然后执行命令检查集群，这边查看集群都是正常，说明这边集群部署成功</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 member list</span><br>42c8b94265b9b79a, started, etcd-2, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>9869f0647883a00d, started, etcd-1, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>c799a6ef06bc8c14, started, etcd-0, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br><br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 endpoint status --write-out=table</span><br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>| 106.53.131.xx<span class="hljs-function">:2379</span> | c799a6ef06bc8c14 |  3.4.13 |   20 kB |     <span class="hljs-literal">false</span> |      <span class="hljs-literal">false</span> |         3 |          9 |                  9 |        |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br></code></pre></td></tr></table></figure><p>下面我们对etcd的pod进行扩缩容看看是否会有影响</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@VM-0-13-centos etcd]<span class="hljs-comment"># kubectl scale statefulsets etcd --replicas=5</span><br>statefulset.apps/etcd scaled<br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># kubectl get pod | grep etcd</span><br>etcd-0   1/1     Running   0          22h<br>etcd-1   1/1     Running   0          22h<br>etcd-2   1/1     Running   0          22h<br>etcd-3   2/2     Running   0          78s<br>etcd-4   2/2     Running   2          53s<br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 endpoint status --write-out=table</span><br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>| 106.53.131.xx<span class="hljs-function">:2379</span> | 42c8b94265b9b79a |  3.4.13 |   20 kB |      <span class="hljs-literal">true</span> |      <span class="hljs-literal">false</span> |         3 |         11 |                 11 |        |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 member list</span><br>42c8b94265b9b79a, started, etcd-2, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>9869f0647883a00d, started, etcd-1, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>c799a6ef06bc8c14, started, etcd-0, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>ef933addf9d37a32, started, etcd-3, http:<span class="hljs-string">//etcd-3.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-3.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># kubectl scale statefulsets etcd --replicas=3</span><br>statefulset.apps/etcd scaled<br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># kubectl get pod | grep etcd</span><br>etcd-0   1/1     Running   0          22h<br>etcd-1   1/1     Running   0          22h<br>etcd-2   1/1     Running   0          22h<br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 member list</span><br>42c8b94265b9b79a, started, etcd-2, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-2.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>9869f0647883a00d, started, etcd-1, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-1.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>c799a6ef06bc8c14, started, etcd-0, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2380</span>, http:<span class="hljs-string">//etcd-0.etcd.default.svc.cluster.local</span><span class="hljs-function">:2379</span>, <span class="hljs-literal">false</span><br>[root@VM-0-13-centos etcd]<span class="hljs-comment"># etcdctl --endpoints 106.53.131.xx:2379 endpoint status --write-out=table</span><br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br>| 106.53.131.xx<span class="hljs-function">:2379</span> | c799a6ef06bc8c14 |  3.4.13 |   20 kB |     <span class="hljs-literal">false</span> |      <span class="hljs-literal">false</span> |         3 |         12 |                 12 |        |<br>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">------------------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">---------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">-----------</span>+<span class="hljs-params">------------</span>+<span class="hljs-params">--------------------</span>+<span class="hljs-params">--------</span>+<br></code></pre></td></tr></table></figure><p>这边扩缩容都是正常，这边可以给etcd配置hpa来实现整真正的高可用。</p><h1 id="etcdctl常用的命令"><a href="#etcdctl常用的命令" class="headerlink" title="etcdctl常用的命令"></a>etcdctl常用的命令</h1><p>为了执行命名方便，我们在客户端机器直接写这个alias，将下面命令写到root目录下的.bashrc文件然后bash一下这个文件，新开一个session窗口，后续直接执行etcdcluster这个命令加参数即可。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">etcdcluster</span>=&#x27;etcdctl --endpoints <span class="hljs-number">106</span>.<span class="hljs-number">53</span>.<span class="hljs-number">131</span>.xx:<span class="hljs-number">2379</span>&#x27;<br></code></pre></td></tr></table></figure><h2 id="PUT-options"><a href="#PUT-options" class="headerlink" title="PUT [options]  "></a>PUT [options]<key><value></value></key></h2><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]<span class="hljs-comment"># etcdcluster  put foo bar </span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]<span class="hljs-comment"># etcdcluster  get foo</span><br>foo<br>ba<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]<span class="hljs-comment"># etcdcluster put foo bar1 --prev-kv //覆盖之前的值</span><br>OK<br>foo<br>bar[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]<span class="hljs-comment"># etcdcluster get foo</span><br>foo<br>bar1<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos etcd]<span class="hljs-comment"># etcdcluster put foo &quot;bar1 2 3&quot; //插入多个value值</span><br>OK<br></code></pre></td></tr></table></figure><h2 id="GET-options-range-end"><a href="#GET-options-range-end" class="headerlink" title="GET [options]  [range_end]"></a>GET [options]<key>[range_end]</key></h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put foo1 bar1</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put foo2 bar2</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put foo3 bar3</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put foo bar</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster get foo</span><br>foo<br><span class="hljs-keyword">bar</span><br><span class="hljs-keyword"></span>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster get --from-key &#x27;&#x27; //获取所有的键</span><br>foo<br><span class="hljs-keyword">bar</span><br><span class="hljs-keyword"></span>foo1<br><span class="hljs-keyword">bar1</span><br><span class="hljs-keyword"></span>foo2<br><span class="hljs-keyword">bar2</span><br><span class="hljs-keyword"></span>foo3<br><span class="hljs-keyword">bar3</span><br><span class="hljs-keyword"></span>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster get --from-key foo1  //获取名称大于或等于的所有键</span><br>foo1<br><span class="hljs-keyword">bar1</span><br><span class="hljs-keyword"></span>foo2<br><span class="hljs-keyword">bar2</span><br><span class="hljs-keyword"></span>foo3<br><span class="hljs-keyword">bar3[root@VM-0-13-centos </span>~]<span class="hljs-comment"># etcdcluster get foo1 foo3 //获取名称大于等于foo1且小于foo2的所有键</span><br>foo1<br><span class="hljs-keyword">bar1</span><br><span class="hljs-keyword"></span>foo2<br><span class="hljs-keyword">bar2</span><br></code></pre></td></tr></table></figure><h2 id="DEL-options-range-end"><a href="#DEL-options-range-end" class="headerlink" title="DEL [options]  [range_end]"></a>DEL [options]<key>[range_end]</key></h2><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put foo bar</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster del foo </span><br><span class="hljs-number">1</span><br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put key val //删除某个键</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster del --prev-kv key //返回删除的键值</span><br><span class="hljs-number">1</span><br>key<br>val<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put a 123</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put b 456</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put c 789</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster del --from-key a //从某个键开始删除</span><br><span class="hljs-number">6</span><br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster get --from-key a //检查a后面的是否删除</span><br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put zoo val</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put zoo1 val1</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster put zoo2 val2</span><br>OK<br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster del --prefix zoo //键值前缀匹配删除</span><br><span class="hljs-number">3</span><br>[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]<span class="hljs-comment"># etcdcluster get --from-key zoo</span><br></code></pre></td></tr></table></figure><h2 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h2><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mel">[root@VM<span class="hljs-number">-0</span><span class="hljs-number">-13</span>-centos ~]# etcdcluster <span class="hljs-keyword">snapshot</span> save <span class="hljs-keyword">snapshot</span>.db<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-number">1605871537.932119</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:119&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;created temporary db file&quot;</span>,<span class="hljs-string">&quot;path&quot;</span>:<span class="hljs-string">&quot;snapshot.db.part&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2020-11-20T19:25:37.933+0800&quot;</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;clientv3/maintenance.go:200&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;opened snapshot stream; downloading&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-number">1605871537.9336457</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:127&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;fetching snapshot&quot;</span>,<span class="hljs-string">&quot;endpoint&quot;</span>:<span class="hljs-string">&quot;106.53.131.85:2379&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2020-11-20T19:25:37.935+0800&quot;</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;clientv3/maintenance.go:208&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;completed snapshot read; closing&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-number">1605871537.9402754</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:142&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;fetched snapshot&quot;</span>,<span class="hljs-string">&quot;endpoint&quot;</span>:<span class="hljs-string">&quot;106.53.131.85:2379&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-string">&quot;25 kB&quot;</span>,<span class="hljs-string">&quot;took&quot;</span>:<span class="hljs-number">0.00810019</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-number">1605871537.9403143</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:152&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;saved&quot;</span>,<span class="hljs-string">&quot;path&quot;</span>:<span class="hljs-string">&quot;snapshot.db&quot;</span>&#125;<br>Snapshot saved at <span class="hljs-keyword">snapshot</span>.db<br></code></pre></td></tr></table></figure><h2 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata">[root@VM-0-13-centos ~]# etcdcluster snapshot <span class="hljs-keyword">restore</span> snapshot.<span class="hljs-keyword">db</span> --data-<span class="hljs-keyword">dir</span>=/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">run</span>/etcd<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1605871714.2255018,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:296&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;restoring snapshot&quot;</span>,<span class="hljs-string">&quot;path&quot;</span>:<span class="hljs-string">&quot;snapshot.db&quot;</span>,<span class="hljs-string">&quot;wal-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd/member/wal&quot;</span>,<span class="hljs-string">&quot;data-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd&quot;</span>,<span class="hljs-string">&quot;snap-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd/member/snap&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1605871714.2265532,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;membership/cluster.go:392&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;added member&quot;</span>,<span class="hljs-string">&quot;cluster-id&quot;</span>:<span class="hljs-string">&quot;cdf818194e3a8c32&quot;</span>,<span class="hljs-string">&quot;local-member-id&quot;</span>:<span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-string">&quot;added-peer-id&quot;</span>:<span class="hljs-string">&quot;8e9e05c52164694d&quot;</span>,<span class="hljs-string">&quot;added-peer-peer-urls&quot;</span>:[<span class="hljs-string">&quot;http://localhost:2380&quot;</span>]&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1605871714.242329,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;snapshot/v3_snapshot.go:309&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;restored snapshot&quot;</span>,<span class="hljs-string">&quot;path&quot;</span>:<span class="hljs-string">&quot;snapshot.db&quot;</span>,<span class="hljs-string">&quot;wal-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd/member/wal&quot;</span>,<span class="hljs-string">&quot;data-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd&quot;</span>,<span class="hljs-string">&quot;snap-dir&quot;</span>:<span class="hljs-string">&quot;/var/run/etcd/member/snap&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>这里只做一些常用简单的命令进行操作，更多的命令使用可以参考<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/tree/master/etcdctl%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8%E3%80%82">https://github.com/etcd-io/etcd/tree/master/etcdctl进行操作使用。</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Kubernetes/" class="category-chain-item">Kubernetes</a> <span>></span> <a href="/categories/Kubernetes/etcd/" class="category-chain-item">etcd</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Kubernetes/">#Kubernetes</a> <a href="/tags/etcd/">#etcd</a></div></div><div class="license-box my-3"><div class="license-title"><div>Kubernetes之etcd数据库</div><div>https://www.niewx.cn/2020/11/19/2020-11-19-Etcd-database-of-Kubernetes/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>VashonNie</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2020年11月19日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2020/11/25/2020-11-25-kubectl-access-to-many-clusters/" title="Kubernetes之多集群的访问"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Kubernetes之多集群的访问</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2020/11/17/2020-11-17-Pod-creation-process-in-Kubernetes/" title="Kubernetes中pod的创建流程"><span class="hidden-mobile">Kubernetes中pod的创建流程</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.4.16/Valine.min.js",(function(){var i=Object.assign({appId:"XirY0sfpYd0HU4g4MjKSR39K-gzGzoHsz",appKey:"TuwIbmst7Q1N12V1EgEfVgDm",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div id="music_div" style="position:fixed;bottom:0;left:30px"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="110" src="//music.163.com/outchain/player?type=0&id=919444742&auto=1&height=90"></iframe><script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script><script src="/js/musicshow.js"></script></div><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?bfe4709ccd8c5c9e559c89f4fd0866f3";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script>!function(){var e=CONFIG.code_language.enable&&CONFIG.code_language.default,a=CONFIG.copy_btn;if(e||a){var i="";i+='<div class="code-widget">',i+="LANG",i+="</div>",jQuery(".markdown-body pre").each((function(){var n=jQuery(this);if(!(n.find("code.mermaid").length>0||n.find("span.line").length>0)){var t,c="";e&&(c=CONFIG.code_language.default,n[0].children.length>0&&n[0].children[0].classList.length>=2&&n.children().hasClass("hljs")?c=n[0].children[0].classList[1]:n[0].getAttribute("data-language")?c=n[0].getAttribute("data-language"):n.parent().hasClass("sourceCode")&&n[0].children.length>0&&n[0].children[0].classList.length>=2?(c=n[0].children[0].classList[1],n.parent().addClass("code-wrapper")):n.parent().hasClass("markdown-body")&&0===n[0].classList.length&&n.wrap('<div class="code-wrapper"></div>'),c=c.toUpperCase().replace("NONE",CONFIG.code_language.default)),n.append(i.replace("LANG",c).replace('code-widget">',(t=n[0],(Fluid.utils.getBackgroundLightness(t)>=0?"code-widget-light":"code-widget-dark")+(a?' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>':' code-widget">')))),a&&Fluid.utils.createScript("https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js",(function(){new window.ClipboardJS(".copy-btn",{target:function(e){for(var a=e.parentNode.childNodes,i=0;i<a.length;i++)if("CODE"===a[i].tagName)return a[i]}}).on("success",(function(e){e.clearSelection(),e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-copy","icon-success"),setTimeout((function(){e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-success","icon-copy")}),2e3)}))}))}}))}}()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="/js/leancloud.js"></script><script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/DynamicRibbon.min.js"></script><script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script><script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/love.min.js"></script><script src="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="//cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"right",width:180,height:360},mobile:{show:!0},react:{opacity:.7},log:!1})</script></body></html>