<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="聂伟星个人技术博客"><meta name="keyword" content="聂伟星，博客"><link rel="shortcut icon" href="/img/ironman-draw.png"><script async defer="defer" src="https://buttons.github.io/buttons.js"></script><title>腾讯云cvm上搭建openvpn内网访问vpc - 聂伟星个人技术博客</title><link rel="canonical" href="https://www.niewx.cn/2021/03/25/Build-openvpn-intranet-access-vpc-on-cvm/"><link rel="stylesheet" href="../../../../css/bootstrap.min.css"><link rel="stylesheet" href="../../../../css/dusign-dark.css"><link rel="stylesheet" href="../../../../css/dusign-common-dark.css"><link rel="stylesheet" href="../../../../css/font-awesome.css"><link rel="stylesheet" href="../../../../css/toc.css"><link rel="stylesheet" href="../../../../css/highlight.css"><link rel="stylesheet" href="../../../../css/widget.css"><link rel="stylesheet" href="../../../../css/rocket.css"><link rel="stylesheet" href="../../../../css/signature.css"><link rel="stylesheet" href="../../../../css/fonts.googleapis.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="../../../../css/photography.css"><script></script><meta name="generator" content="Hexo 4.2.1"></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.5)),url(snail-bg.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#linux" title="linux">linux</a> <a class="tag" href="/tags/#openvpn" title="openvpn">openvpn</a></div><h1>腾讯云cvm上搭建openvpn内网访问vpc</h1><h2 class="subheading"></h2><span class="meta">Posted by VashonNie on 2021-03-25</span><div class="blank_box"></div><span class="meta">Words <span class="post-count">2.5k</span> and Reading Time <span class="post-count">14</span> Minutes</span><div class="blank_box"></div><span class="meta">Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times</span></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/img/wave-dark.png)"></div><div class="wave wave_after" style="background-image:url(/img/wave-dark.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">聂伟星</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/photography/">Photography</a></li><li><a href="/tags/">Tags</a></li><li><a href="/categories/">Categories</a></li><li><a href="/archive/">Archives</a></li><li><a href="/random.html">Random Post</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">Gitbook</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><p>我们在使用共有云的时候，有时候会需要本地电脑访问到云上的vpc机器，但是云上vpc是网络隔离的，如果不加公网ip是无法直接本地访问vpc的，其实这里我们只需要在vpc内有一台机器可以访问公网，然后再这台集群上搭建openvpn，这样本地就可以通过openvpn去直接连接vpc内其他内网机器，不用每台机器都配置公网ip了，下面我们来说下如何在腾讯云的cvm上搭建openvpn。</p><h1 id="网络规划"><a href="#网络规划" class="headerlink" title="网络规划"></a>网络规划</h1><p>vpc网段：10.0.0.0/16</p><p>openvpn分配给客户端的网段：192.168.1.0/24</p><p>openvpn服务端ip：10.0.0.13(内网)，106.53.146.250(公网)</p><h1 id="安装openvpn"><a href="#安装openvpn" class="headerlink" title="安装openvpn"></a>安装openvpn</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install openvpn</span></span><br><span class="line"><span class="comment"># wget  https://github.com/OpenVPN/easy-rsa/archive/master.zip</span></span><br><span class="line"><span class="comment"># unzip master.zip</span></span><br><span class="line"><span class="comment"># mv easy-rsa-master/ easy-rsa</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/</span></span><br><span class="line"><span class="comment"># cp -R easy-rsa/ /etc/</span></span><br><span class="line"><span class="comment"># cd /etc/</span></span><br><span class="line"><span class="comment"># mkdir client server</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">client  easy-rsa  server</span><br></pre></td></tr></table></figure><h1 id="配置vars文件"><a href="#配置vars文件" class="headerlink" title="配置vars文件"></a>配置vars文件</h1><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /etc/easy-rsa/easyrsa3</span></span><br><span class="line"><span class="comment"># cp vars.example vars</span></span><br><span class="line"><span class="comment"># vim vars</span></span><br><span class="line">根据实际修改对应的配置</span><br><span class="line"><span class="string">.......</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_COUNTRY     <span class="string">"CN"</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_PROVINCE    <span class="string">"SZ"</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_CITY        <span class="string">"GD"</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_ORG         <span class="string">"test"</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_EMAIL       <span class="string">"nwx_qdlg@163.com"</span></span><br><span class="line"><span class="keyword">set</span>_var EASYRSA_REQ_OU          <span class="string">"test"</span></span><br><span class="line"><span class="string">.......</span></span><br></pre></td></tr></table></figure><h1 id="创建server端证书"><a href="#创建server端证书" class="headerlink" title="创建server端证书"></a>创建server端证书</h1><h2 id="初始化目录"><a href="#初始化目录" class="headerlink" title="初始化目录"></a>初始化目录</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]# ls</span><br><span class="line">easyrsa  openssl-easyrsa.cnf  vars  vars.example  x509-types</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]#  ./easyrsa init-pki</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line"></span><br><span class="line">init-pki complete; you may now create a CA <span class="keyword">or</span> requests.</span><br><span class="line">Your newly created PKI dir <span class="keyword">is</span>: /etc/easy-rsa/easyrsa3/pki</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]# ls</span><br><span class="line">easyrsa  openssl-easyrsa.cnf  pki  vars  vars.example  x509-types</span><br></pre></td></tr></table></figure><h2 id="创建CA证书"><a href="#创建CA证书" class="headerlink" title="创建CA证书"></a>创建CA证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa build-ca</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line">Enter New CA Key Passphrase:  #输入CA密码，记录下</span><br><span class="line">Re-Enter New CA Key Passphrase: #确认密码</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+++</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter is what is called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a<span class="built_in"> default </span>value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, <span class="keyword">or</span><span class="built_in"> server </span>name) [Easy-RSA CA]:server  # ca证书名称</span><br><span class="line"></span><br><span class="line">CA creation complete <span class="keyword">and</span> you may now import <span class="keyword">and</span> sign cert requests.</span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at:</span><br><span class="line">/etc/easy-rsa/easyrsa3/pki/ca.crt</span><br></pre></td></tr></table></figure><h2 id="创建服务端证书"><a href="#创建服务端证书" class="headerlink" title="创建服务端证书"></a>创建服务端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa gen-req<span class="built_in"> server </span>nopass</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+++</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+++</span><br><span class="line">writing new private key <span class="keyword">to</span> <span class="string">'/etc/easy-rsa/easyrsa3/pki/easy-rsa-32328.KOVmFR/tmp.kdL0Yx'</span></span><br><span class="line">-----</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter is what is called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a<span class="built_in"> default </span>value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, <span class="keyword">or</span><span class="built_in"> server </span>name) [server]:vpc-server #输入服务端名称</span><br><span class="line"></span><br><span class="line">Keypair <span class="keyword">and</span> certificate request completed. Your files are:</span><br><span class="line">req: /etc/easy-rsa/easyrsa3/pki/reqs/server.req</span><br><span class="line">key: /etc/easy-rsa/easyrsa3/pki/private/server.key</span><br></pre></td></tr></table></figure><h2 id="签约服务端证书"><a href="#签约服务端证书" class="headerlink" title="签约服务端证书"></a>签约服务端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa sign<span class="built_in"> server </span>server</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You are about <span class="keyword">to</span> sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy.<span class="built_in"> Note </span>that this request</span><br><span class="line">has <span class="keyword">not</span> been cryptographically verified. Please be sure it came <span class="keyword">from</span> a trusted</span><br><span class="line">source <span class="keyword">or</span> that you have verified the request checksum with the sender.</span><br><span class="line"></span><br><span class="line">Request subject, <span class="keyword">to</span> be signed as a<span class="built_in"> server </span>certificate <span class="keyword">for</span> 825 days:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = vpc-server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">'yes'</span> <span class="keyword">to</span> continue, <span class="keyword">or</span> any other input <span class="keyword">to</span> abort.</span><br><span class="line">  Confirm request details: <span class="literal">yes</span>  #输入<span class="literal">yes</span></span><br><span class="line">Using configuration <span class="keyword">from</span> /etc/easy-rsa/easyrsa3/pki/easy-rsa-345.HZwt53/tmp.7IIgHU</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /etc/easy-rsa/easyrsa3/pki/private/ca.key:  #输入之前配置的CA密码</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">'s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:'</span>vpc-server<span class="string">'</span></span><br><span class="line"><span class="string">Certificate is to be certified until Jun 29 09:02:24 2023 GMT (825 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certificate created at: /etc/easy-rsa/easyrsa3/pki/issued/server.crt</span></span><br></pre></td></tr></table></figure><h2 id="创建数据穿越密钥"><a href="#创建数据穿越密钥" class="headerlink" title="创建数据穿越密钥"></a>创建数据穿越密钥</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa gen-dh</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating DH parameters, 2048 bit long safe prime, generator 2</span><br><span class="line">This is going <span class="keyword">to</span> take a long time</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.+<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">DH parameters of size 2048 created at /etc/easy-rsa/easyrsa3/pki/dh.pem</span><br></pre></td></tr></table></figure><h1 id="创建client证书"><a href="#创建client证书" class="headerlink" title="创建client证书"></a>创建client证书</h1><h2 id="初始化目录-1"><a href="#初始化目录-1" class="headerlink" title="初始化目录"></a>初始化目录</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]# cd /etc/client/</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# cp -R /root/easy-rsa/easyrsa3/ .</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# ll</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root <span class="number">4096</span> Mar <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> easyrsa3</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# cd easyrsa3/</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]# ./easyrsa init-pki</span><br><span class="line"></span><br><span class="line">init-pki complete; you may now create a CA <span class="keyword">or</span> requests.</span><br><span class="line">Your newly created PKI dir <span class="keyword">is</span>: /etc/client/easyrsa3/pki</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos easyrsa3]# ls</span><br><span class="line">easyrsa  openssl-easyrsa.cnf  pki  vars.example  x509-types</span><br></pre></td></tr></table></figure><h2 id="创建客户端CA证书"><a href="#创建客户端CA证书" class="headerlink" title="创建客户端CA证书"></a>创建客户端CA证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa build-ca</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line">Enter New CA Key Passphrase: #输入ca密码</span><br><span class="line">Re-Enter New CA Key Passphrase: #确认CA密码</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.+++</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter is what is called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a<span class="built_in"> default </span>value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, <span class="keyword">or</span><span class="built_in"> server </span>name) [Easy-RSA CA]:client-ca #输入ca证书名称</span><br><span class="line"></span><br><span class="line">CA creation complete <span class="keyword">and</span> you may now import <span class="keyword">and</span> sign cert requests.</span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at:</span><br><span class="line">/etc/client/easyrsa3/pki/ca.crt</span><br></pre></td></tr></table></figure><h2 id="创建客户端证书"><a href="#创建客户端证书" class="headerlink" title="创建客户端证书"></a>创建客户端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa gen-req client</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>+++</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.+++</span><br><span class="line">writing new private key <span class="keyword">to</span> <span class="string">'/etc/client/easyrsa3/pki/easy-rsa-1789.jZxBCq/tmp.1l4buX'</span></span><br><span class="line">Enter PEM pass phrase:  #输入客户端CA密码，也是将来登录VPN客户密码！</span><br><span class="line">Verifying - Enter PEM pass phrase:</span><br><span class="line">-----</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter is what is called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a<span class="built_in"> default </span>value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, <span class="keyword">or</span><span class="built_in"> server </span>name) [client]:niewx #起名字</span><br><span class="line"></span><br><span class="line">Keypair <span class="keyword">and</span> certificate request completed. Your files are:</span><br><span class="line">req: /etc/client/easyrsa3/pki/reqs/client.req</span><br><span class="line">key: /etc/client/easyrsa3/pki/private/client.key</span><br></pre></td></tr></table></figure><h2 id="导入客户端证书"><a href="#导入客户端证书" class="headerlink" title="导入客户端证书"></a>导入客户端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# cd /etc/easy-rsa/easyrsa3</span><br><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa import-req /etc/client/easyrsa3/pki/reqs/client.req client</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration <span class="keyword">from</span>: /etc/easy-rsa/easyrsa3/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line">The request has been successfully imported with a short name of: client</span><br><span class="line">You may now use this name <span class="keyword">to</span> perform signing operations on this request.</span><br></pre></td></tr></table></figure><h2 id="签约客户端证书"><a href="#签约客户端证书" class="headerlink" title="签约客户端证书"></a>签约客户端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos easyrsa3]# cd /etc/easy-rsa/easyrsa3</span><br><span class="line">[root@VM-0-13-centos easyrsa3]# ./easyrsa sign<span class="built_in"> client </span>client</span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You are about <span class="keyword">to</span> sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy.<span class="built_in"> Note </span>that this request</span><br><span class="line">has <span class="keyword">not</span> been cryptographically verified. Please be sure it came <span class="keyword">from</span> a trusted</span><br><span class="line">source <span class="keyword">or</span> that you have verified the request checksum with the sender.</span><br><span class="line"></span><br><span class="line">Request subject, <span class="keyword">to</span> be signed as a<span class="built_in"> client </span>certificate <span class="keyword">for</span> 825 days:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = niewx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">'yes'</span> <span class="keyword">to</span> continue, <span class="keyword">or</span> any other input <span class="keyword">to</span> abort.</span><br><span class="line">  Confirm request details: <span class="literal">yes</span> # 输入<span class="literal">yes</span></span><br><span class="line">Using configuration <span class="keyword">from</span> /etc/client/easyrsa3/pki/easy-rsa-2777.2aZHdK/tmp.9RSG1Q</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /etc/client/easyrsa3/pki/private/ca.key: #客户端ca密码</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">'s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:'</span>niewx<span class="string">'</span></span><br><span class="line"><span class="string">Certificate is to be certified until Jun 29 09:16:55 2023 GMT (825 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certificate created at: /etc/easy-rsa/easyrsa3/pki/issued/client.crt</span></span><br></pre></td></tr></table></figure><h1 id="openvpn服务端配置"><a href="#openvpn服务端配置" class="headerlink" title="openvpn服务端配置"></a>openvpn服务端配置</h1><h2 id="拷贝服务端证书文件"><a href="#拷贝服务端证书文件" class="headerlink" title="拷贝服务端证书文件"></a>拷贝服务端证书文件</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos pki]# cd /etc/easy-rsa/easyrsa3/pki</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos pki]# cp ca.crt /etc/server/</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos pki]# cp <span class="keyword">private</span>/server.key /etc/server/</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos pki]# cp issued/server.crt /etc/server/</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos pki]# cp dh.pem /etc/server/</span><br></pre></td></tr></table></figure><h2 id="拷贝客户端证书"><a href="#拷贝客户端证书" class="headerlink" title="拷贝客户端证书"></a>拷贝客户端证书</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos pki]# cd /etc/client/easyrsa3</span><br><span class="line">[root@VM-0-13-centos pki]# cp /etc/easy-rsa/easyrsa3/pki/ca.crt /etc/client</span><br><span class="line">[root@VM-0-13-centos private]# cp /etc/client/easyrsa3/pki/private/client.key /etc/client</span><br><span class="line">[root@VM-0-13-centos issued]# cp /etc/easy-rsa/easyrsa3/pki/issued/client.crt /etc/client</span><br><span class="line">[root@VM-0-13-centos issued]# cd /etc/client/</span><br><span class="line">[root@VM-0-13-centos client]# ls</span><br><span class="line">ca.crt  client.crt  client.key  easyrsa3</span><br><span class="line">[root@VM-0-13-centos client]# cd /etc/server/</span><br><span class="line">[root@VM-0-13-centos server]# ls</span><br><span class="line">ca.crt  dh.pem  server.crt  server.key</span><br></pre></td></tr></table></figure><h2 id="配置server-conf"><a href="#配置server-conf" class="headerlink" title="配置server.conf"></a>配置server.conf</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos openvpn]# cd /etc/openvpn</span><br><span class="line">[root@VM-0-13-centos openvpn]# vim server.conf</span><br><span class="line"></span><br><span class="line">local 0.0.0.0</span><br><span class="line">port 55555</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca /etc/server/ca.crt</span><br><span class="line">cert /etc/server/server.crt</span><br><span class="line">key /etc/server/server.key  # This file should be kept secret</span><br><span class="line">dh /etc/server/dh.pem</span><br><span class="line">server 192.168.1.0 255.255.255.0</span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">keepalive 10 120</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">verb 3</span><br><span class="line">comp-lzo</span><br><span class="line">push <span class="string">"route 10.0.0.0 255.0.0.0"</span></span><br><span class="line">client-to-client</span><br><span class="line">log /var/log/openvpn.log</span><br></pre></td></tr></table></figure><h2 id="配置转发参数和iptables规则"><a href="#配置转发参数和iptables规则" class="headerlink" title="配置转发参数和iptables规则"></a>配置转发参数和iptables规则</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos openvpn]# sed -i <span class="string">'/net.ipv4.ip_forward/ s/\(.*= \).*/\11/'</span> /etc/sysctl.conf</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# iptables -t nat -A POSTROUTING -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> -o eth0 -j MASQUERADE</span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# iptables -nL -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">MASQUERADE  all  --  <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="启动oepnven服务端"><a href="#启动oepnven服务端" class="headerlink" title="启动oepnven服务端"></a>启动oepnven服务端</h1><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# openvpn /etc/server.conf &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">5785</span></span><br><span class="line">[<span class="symbol">root@</span>VM<span class="number">-0</span><span class="number">-13</span>-centos client]# ps -ef | grep openvpn</span><br><span class="line">root      <span class="number">5785</span> <span class="number">26254</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">37</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> openvpn /etc/server.conf</span><br></pre></td></tr></table></figure><h1 id="本地机器安装openvpn客户端"><a href="#本地机器安装openvpn客户端" class="headerlink" title="本地机器安装openvpn客户端"></a>本地机器安装openvpn客户端</h1><p>可以到<a href="https://openvpn.net/community-downloads/" target="_blank" rel="noopener">https://openvpn.net/community-downloads/</a>下载对应系统客户端安装包</p><h1 id="拷贝客户端证书到本地目录"><a href="#拷贝客户端证书到本地目录" class="headerlink" title="拷贝客户端证书到本地目录"></a>拷贝客户端证书到本地目录</h1><p>主要/etc/client目录下拷贝ca.crt，client.crt，client.key，然后配置下文件client.ovpn，内容如下</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">client</span> <span class="string"></span></span><br><span class="line"><span class="attr">dev</span> <span class="string">tun </span></span><br><span class="line"><span class="attr">proto</span> <span class="string">tcp </span></span><br><span class="line"><span class="attr">remote</span> <span class="string">106.53.146.250  55555</span></span><br><span class="line"><span class="meta">resolv-retry</span> <span class="string">infinite </span></span><br><span class="line"><span class="attr">nobind</span> <span class="string"></span></span><br><span class="line"><span class="meta">persist-key</span> <span class="string"></span></span><br><span class="line"><span class="meta">persist-tun</span> <span class="string"></span></span><br><span class="line"><span class="attr">ca</span> <span class="string">ca.crt </span></span><br><span class="line"><span class="attr">cert</span> <span class="string">client1.crt</span></span><br><span class="line"><span class="attr">key</span> <span class="string">client1.key </span></span><br><span class="line"><span class="meta">comp-lzo</span> <span class="string"></span></span><br><span class="line"><span class="attr">verb</span> <span class="string">3</span></span><br></pre></td></tr></table></figure><h1 id="运行vpn连接服务端"><a href="#运行vpn连接服务端" class="headerlink" title="运行vpn连接服务端"></a>运行vpn连接服务端</h1><p><img src="1.png" alt="upload-image"></p><p><img src="2.png" alt="upload-image"></p><p>连接成功后，我们直接内网访问下服务，发现可以直接内网ip访问到prometheus的UI界面，这里说明我们本地电脑成功连接了vpc</p><p><img src="3.png" alt="upload-image"></p><h1 id="自动生成客户端的脚本"><a href="#自动生成客户端的脚本" class="headerlink" title="自动生成客户端的脚本"></a>自动生成客户端的脚本</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-13-centos client]# cd /etc/client</span><br><span class="line">[root@VM-0-13-centos client]# cat auto-generate-client.sh</span><br><span class="line"><span class="comment"># ! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="builtin-name">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="attribute">OVPN_USER_KEYS_DIR</span>=/etc/client/keys</span><br><span class="line"><span class="attribute">EASY_RSA_VERSION</span>=easyrsa3</span><br><span class="line"><span class="attribute">EASY_RSA_DIR</span>=/etc/easy-rsa</span><br><span class="line"><span class="attribute">PKI_DIR</span>=<span class="variable">$EASY_RSA_DIR</span>/$EASY_RSA_VERSION/pki</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span><span class="built_in"> user </span><span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>"</span> ]; then</span><br><span class="line">    rm -rf <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">    rm -rf  <span class="variable">$PKI_DIR</span>/reqs/<span class="variable">$user</span>.req</span><br><span class="line">    rm -rf  <span class="variable">$PKI_DIR</span>/private/<span class="variable">$user</span>.key</span><br><span class="line">    rm -rf  <span class="variable">$PKI_DIR</span>/issued/<span class="variable">$user</span>.crt</span><br><span class="line">    sed -i <span class="string">'/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/d'</span> <span class="variable">$PKI_DIR</span>/index.txt  #通过index.txt文件查看到证书的情况，首字母为R的证书就是已经被吊销的证书。</span><br><span class="line">    exit 0</span><br><span class="line">  fi</span><br><span class="line">  cd <span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span></span><br><span class="line">  # 生成客户端 ssl 证书文件</span><br><span class="line">  ./easyrsa build-client-full <span class="variable">$user</span> nopass</span><br><span class="line">  # 整理下生成的文件</span><br><span class="line">  mkdir -p  <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/ca.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   # CA 根证书</span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/issued/<span class="variable">$user</span>.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   # 客户端证书</span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/private/<span class="variable">$user</span>.key <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/  # 客户端证书密钥</span><br><span class="line">  cp /etc/client/sample.ovpn <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn # 客户端配置文件</span><br><span class="line">  sed -i <span class="string">'s/admin/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/g'</span> <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn</span><br><span class="line">  cd <span class="variable">$OVPN_USER_KEYS_DIR</span></span><br><span class="line">  zip -r <span class="variable">$user</span>.zip <span class="variable">$user</span></span><br><span class="line">done</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><p>脚本会自动生成客户端证书，执行方式如下，如果需要生成多个用户则在参数加上就行</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh  auto-<span class="keyword">generate</span>-client<span class="variable">.sh</span> test1 test2 .....</span><br></pre></td></tr></table></figure><p><img src="4.png" alt="upload-image"></p><p>将对应的zip包拷贝给用户，然后再openvpn中指定对应的ovpn文件进行配置下连接即可</p><hr><ul class="pager"><li class="previous"><a href="/2021/04/08/k8s-deploy-thanos/" data-toggle="tooltip" data-placement="top" title="k8s上部署thanos监控系统">&larr; Previous Post</a></li><li class="next"><a href="/2021/03/19/How-does-istio's-VirtualService-limit-CORS-request-headers/" data-toggle="tooltip" data-placement="top" title="istio之VirtualService如何限制CORS请求头">Next Post &rarr;</a></li></ul><div class="comment_notes_blank"></div><div class="visitor_notice"><img src="/img/notice.png" alt="notice" title="notice"><p class="notice">欢迎访问 <a href="https://www.niewx.cn" target="Vashon">Vashon</a> 的博客，博客和文章在完善中，请大家耐心等待。 若有问题或者有好的建议欢迎留言，笔者看到之后会及时回复。</p></div><div class="comment_notes"><p></p></div><link rel="stylesheet" href="../../../../css/music-player/fonts/iconfont.css"><link rel="stylesheet" href="../../../../css/music-player/css/reset.css"><link rel="stylesheet" href="../../../../css/music-player/css/player.css"><div class="music-player"><audio class="music-player__audio"></audio><div class="music-player__main"><div class="music-player__blur"></div><div class="music-player__disc"><div class="music-player__image"><img width="100%" src="" alt=""></div><div class="music-player__pointer"><img width="100%" src="/img/cd_tou.png" alt=""></div></div><div class="music-player__controls"><div class="music__info"><h3 class="music__info--title">...</h3><p class="music__info--singer">...</p></div><div class="player-control"><div class="player-control__content"><div class="player-control__btns"><div class="player-control__btn player-control__btn--prev"><i class="iconfont icon-prev"></i></div><div class="player-control__btn player-control__btn--play"><i class="iconfont icon-play"></i></div><div class="player-control__btn player-control__btn--next"><i class="iconfont icon-next"></i></div><div class="player-control__btn player-control__btn--mode"><i class="iconfont icon-loop"></i></div></div><div class="player-control__volume"><div class="control__volume--icon player-control__btn"><i class="iconfont icon-volume"></i></div><div class="control__volume--progress player_progress"></div></div></div><div class="player-control__content"><div class="player__song--progress player_progress"></div><div class="player__song--timeProgess nowTime">00:00</div><div class="player__song--timeProgess totalTime">00:00</div></div></div></div></div></div><script src="../../../../js/music-player/utill.js"></script><script src="../../../../js/music-player/jquery.min.js"></script><script src="../../../../js/music-player/player.js?library=netease&music=https://kg.qq.com/node/play?s=7deFpz7Z26Jmv7di&g_f=share_html"></script><div class="social-share" data-wechat-qrcode-helper="" align="center"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script><hr><div id="lv-container" data-id="city" data-uid="MTAyMC80NzQ3MS8yMzk3MQ=="><script type="text/javascript">!function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((t=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",t.async=!0,n.parentNode.insertBefore(t,n))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#网络规划"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">网络规划</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#安装openvpn"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">安装openvpn</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#配置vars文件"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">配置vars文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#创建server端证书"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">创建server端证书</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#初始化目录"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">初始化目录</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#创建CA证书"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">创建CA证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#创建服务端证书"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">创建服务端证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#签约服务端证书"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">签约服务端证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#创建数据穿越密钥"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">创建数据穿越密钥</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#创建client证书"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">创建client证书</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#初始化目录-1"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">初始化目录</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#创建客户端CA证书"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">创建客户端CA证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#创建客户端证书"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">创建客户端证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#导入客户端证书"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">导入客户端证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#签约客户端证书"><span class="toc-nav-number">5.5.</span> <span class="toc-nav-text">签约客户端证书</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#openvpn服务端配置"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">openvpn服务端配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#拷贝服务端证书文件"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">拷贝服务端证书文件</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#拷贝客户端证书"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">拷贝客户端证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#配置server-conf"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">配置server.conf</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#配置转发参数和iptables规则"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">配置转发参数和iptables规则</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#启动oepnven服务端"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">启动oepnven服务端</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#本地机器安装openvpn客户端"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">本地机器安装openvpn客户端</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#拷贝客户端证书到本地目录"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">拷贝客户端证书到本地目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#运行vpn连接服务端"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">运行vpn连接服务端</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#自动生成客户端的脚本"><span class="toc-nav-number">11.</span> <span class="toc-nav-text">自动生成客户端的脚本</span></a></li></ol></div></aside><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/#linux" title="linux">linux</a> <a class="tag" href="/tags/#openvpn" title="openvpn">openvpn</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://cloud.tencent.com/developer/column/87421" target="_blank">云+社区</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">gitbook</a></li><li><a href="https://github.com/nieweixing" target="_blank">vashon&#39;s Github</a></li><li><a href="https://weibo.com/3264907804/profile?rig" target="_blank">weibo</a></li></ul></div></div></div></article><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style type="text/css">@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://twitter.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.facebook.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/ke-wang-mian-bao-de-you-xia"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 聂伟星 2021<br>Powered by <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener"><i>hexo-theme-snail</i> </a>|<iframe name="star" style="margin-left:2px;margin-bottom:-5px" frameborder="0" scrolling="0" width="100px" height="20px" src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true"></iframe></p></div></div></div></footer><script src="../../../../js/jquery.min.js"></script><script src="../../../../js/bootstrap.min.js"></script><script src="../../../../js/hux-blog.min.js"></script><script src="../../../../js/search.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>0!==$("#tag_cloud").length&&async("https://www.niewx.cn/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="bfe4709ccd8c5c9e559c89f4fd0866f3",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><script type="text/javascript">var search_path="search.xml",path="/"+(search_path=0==search_path.length?"search.xml":search_path);searchFunc(path,"local-search-input","local-search-result")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><a id="rocket" href="#top" class=""></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/mouse-click.js" content="[&quot;🌱&quot;,&quot;just do it&quot;,&quot;🍀&quot;]" color="[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]"></script><script src="/js/ribbonDynamic.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!0},react:{opacity:.7}})</script></body></html>