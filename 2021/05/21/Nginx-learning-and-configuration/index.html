<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="聂伟星个人技术博客"><meta name="keyword" content="聂伟星，博客"><link rel="shortcut icon" href="/img/ironman-draw.png"><script async defer="defer" src="https://buttons.github.io/buttons.js"></script><title>Nginx的学习和配置 - 聂伟星个人技术博客</title><link rel="canonical" href="https://www.niewx.cn/2021/05/21/Nginx-learning-and-configuration/"><link rel="stylesheet" href="../../../../css/bootstrap.min.css"><link rel="stylesheet" href="../../../../css/dusign-light.css"><link rel="stylesheet" href="../../../../css/dusign-common-light.css"><link rel="stylesheet" href="../../../../css/font-awesome.css"><link rel="stylesheet" href="../../../../css/toc.css"><link rel="stylesheet" href="../../../../css/highlight.css"><link rel="stylesheet" href="../../../../css/widget.css"><link rel="stylesheet" href="../../../../css/rocket.css"><link rel="stylesheet" href="../../../../css/signature.css"><link rel="stylesheet" href="../../../../css/fonts.googleapis.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><link rel="stylesheet" href="../../../../css/photography.css"><script></script><meta name="generator" content="Hexo 4.2.1"></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(snail-bg.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#Nginx" title="Nginx">Nginx</a></div><h1>Nginx的学习和配置</h1><h2 class="subheading"></h2><span class="meta">Posted by VashonNie on 2021-05-21</span><div class="blank_box"></div><span class="meta">Words <span class="post-count">2.7k</span> and Reading Time <span class="post-count">12</span> Minutes</span><div class="blank_box"></div><span class="meta">Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times</span></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(/img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">聂伟星</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/categories/">Categories</a></li><li><a href="/photography/">Photography</a></li><li><a href="/archive/">Archives</a></li><li><a href="/tags/">Tags</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">Chinese Blog</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><p>今天我们来学习下nginx常用的一些配置</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">镜像源：sudo rpm -Uvh http:<span class="regexp">//</span>nginx.org<span class="regexp">/packages/</span>centos<span class="regexp">/7/</span>noarch<span class="regexp">/RPMS/</span>nginx-release-centos-<span class="number">7</span>-<span class="number">0</span>.el7.ngx.noarch.rpm</span><br></pre></td></tr></table></figure><p>centos上安装这个镜像源，然后rpm install nginx即可</p><h1 id="Nginx-conf配置文件解析"><a href="#Nginx-conf配置文件解析" class="headerlink" title="Nginx.conf配置文件解析"></a>Nginx.conf配置文件解析</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行用户</span></span><br><span class="line"><span class="attribute">user</span> www-data;    </span><br><span class="line"><span class="comment">#启动进程,通常设置成和cpu的数量相等</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#全局错误日志及PID文件</span></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/error.log;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#工作模式及连接数上限</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">use</span>   <span class="literal">epoll</span>;             <span class="comment">#epoll是多路复用IO(I/O Multiplexing)中的一种方式,但是仅用于linux2.6以上内核,可以大大提高nginx的性能</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;<span class="comment">#单个后台worker process进程的最大并发链接数</span></span><br><span class="line">    <span class="comment"># multi_accept on; </span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">     <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    <span class="attribute">include</span>       /etc/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    <span class="attribute">access_log</span>    /var/log/access.log;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，</span></span><br><span class="line">    <span class="comment">#必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">#连接超时时间</span></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>        <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#开启gzip压缩</span></span><br><span class="line">    <span class="attribute">gzip</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_disable</span> <span class="string">"MSIE [1-6]\.(?!.*SV1)"</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#设定请求缓冲</span></span><br><span class="line">    <span class="attribute">client_header_buffer_size</span>    <span class="number">1k</span>;</span><br><span class="line">    <span class="attribute">large_client_header_buffers</span>  <span class="number">4</span> <span class="number">4k</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="attribute">include</span> /etc/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">    <span class="attribute">include</span> /etc/sites-enabled/*;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">     <span class="attribute">upstream</span> mysvr &#123;</span><br><span class="line">    <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">    <span class="comment">#本机上的Squid开启3128端口</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.8.1:3128</span> weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.8.2:80</span>  weight=<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.8.3:80</span>  weight=<span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#侦听80端口</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        <span class="attribute">server_name</span>  www.xx.com;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">#设定本虚拟主机的访问日志</span></span><br><span class="line">        <span class="attribute">access_log</span>  logs/www.xx.com.access.log  main;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#默认请求</span></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">          <span class="attribute">root</span>   /root;      <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">          <span class="attribute">index</span> index.php index.html index.htm;   <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line"> </span><br><span class="line">          <span class="attribute">fastcgi_pass</span>  www.xx.com;</span><br><span class="line">         <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="variable">$document_root</span>/<span class="variable">$fastcgi_script_name</span>; </span><br><span class="line">          <span class="attribute">include</span> /etc/fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 定义错误提示页面</span></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;  </span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   /root;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#静态文件，nginx自己处理</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ ^/(images|javascript|js|css|flash|media|static)/</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /var/www/virtual/htdocs;</span><br><span class="line">        <span class="comment">#过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span></span><br><span class="line">        <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /root;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME /home/www/www<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#设定查看Nginx状态的地址</span></span><br><span class="line">    <span class="attribute">location</span> /NginxStatus &#123;</span><br><span class="line">        <span class="attribute">stub_status</span>            <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">access_log</span>              <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">auth_basic</span>              <span class="string">"NginxStatus"</span>;</span><br><span class="line">        <span class="attribute">auth_basic_user_file</span>  conf/htpasswd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#禁止访问 .htxxx 文件</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /\.ht</span> &#123;</span><br><span class="line">        <span class="attribute">deny</span> all;</span><br><span class="line">    &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Nginx在dockerfile中的配置"><a href="#Nginx在dockerfile中的配置" class="headerlink" title="Nginx在dockerfile中的配置"></a>Nginx在dockerfile中的配置</h1><p>Dockerfile中执行的方式，注意这里是将自己配置的nginx的配置文件拷贝到了/opt/nginx的目录下面</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD[“nginx”,”-<span class="keyword">p</span>”,”/<span class="keyword">opt</span>/nginx”.”-<span class="keyword">c</span>”,”/<span class="keyword">opt</span>/<span class="keyword">conf</span>/nginx.<span class="keyword">conf</span>”]</span><br></pre></td></tr></table></figure><h1 id="Nginx在配置文件中的内置变量"><a href="#Nginx在配置文件中的内置变量" class="headerlink" title="Nginx在配置文件中的内置变量"></a>Nginx在配置文件中的内置变量</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过arg_&lt;name&gt;的方式可取出相关参数，若请求 /foo?name=Tony&amp;age=2，则 arg_name=tony arg_age=2</span></span><br><span class="line"><span class="meta">$</span><span class="bash">arg_name</span></span><br><span class="line"><span class="meta">$</span><span class="bash">args</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端IP地址二进制</span></span><br><span class="line"><span class="meta">$</span><span class="bash">binary_remote_addr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送到客户端的字节数，不包括响应头</span></span><br><span class="line"><span class="meta">$</span><span class="bash">body_bytes_sent</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送给客户端字节数</span></span><br><span class="line"><span class="meta">$</span><span class="bash">bytes_sent</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接序列号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">connection</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前已经连接的请求书</span></span><br><span class="line"><span class="meta">$</span><span class="bash">connection_requests</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Content-Length 请求头</span></span><br><span class="line"><span class="meta">$</span><span class="bash">content_length</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Content-Type 请求头</span></span><br><span class="line"><span class="meta">$</span><span class="bash">content_type</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cookie 名称</span></span><br><span class="line"><span class="meta">$</span><span class="bash">cookie_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前请求的 root 或 <span class="built_in">alias</span> 的值</span></span><br><span class="line"><span class="meta">$</span><span class="bash">document_root</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与 <span class="variable">$uri</span> 相同</span></span><br><span class="line"><span class="meta">$</span><span class="bash">document_uri</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 优先级：请求行中的 host name，请求头中的 Host，请求匹配的 server name</span></span><br><span class="line"><span class="meta">$</span><span class="bash">host</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> host name</span></span><br><span class="line"><span class="meta">$</span><span class="bash">hostname</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 任意请求头字段。变量名的最后一部分是转换为小写的字段名，用下划线替换破折号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果连接在 SSL 模式下运行，则为 on，否则为空字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">https</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ? 后如果请求行有参数，或者空字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">is_args</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置此变量可以限制响应速度</span></span><br><span class="line"><span class="meta">$</span><span class="bash">limit_rate</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前时间(秒)，分辨率为毫秒</span></span><br><span class="line"><span class="meta">$</span><span class="bash">msec</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx 版本号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">nginx_version</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前 worker 进程号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">pid</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是 pipelined 则为 p，否则为 . </span></span><br><span class="line"><span class="meta">$</span><span class="bash">pipe</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 代理协议头中的客户端地址，否则为空字符串，代理协议之前必须通过在listen指令中设置 proxy_protocol 参数来启用</span></span><br><span class="line"><span class="meta">$</span><span class="bash">proxy_protocol_addr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 来自代理协议头的客户端端口，否则为空字符串，代理协议之前必须通过在listen指令中设置 proxy_protocol 参数来启用</span></span><br><span class="line"><span class="meta">$</span><span class="bash">proxy_protocol_port</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与 <span class="variable">$args</span> 相同</span></span><br><span class="line"><span class="meta">$</span><span class="bash">query_string</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与当前请求的 root 或 <span class="built_in">alias</span> 指令值对应的绝对路径名，所有符号链接都解析为实际路径</span></span><br><span class="line"><span class="meta">$</span><span class="bash">realpath_root</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端地址</span></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_addr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端端口</span></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_port</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 Basic auth 的用户名</span></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 完整的请求行</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求体，当将请求体读入内存缓冲区时，proxy_pass、fastcgi_pass、uwsgi_pass和scgi_pass指令处理的位置可以使用变量的值</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_body</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 具有请求主体的临时文件的名称</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_body_file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果请求完成则为 OK，否则为空</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_completion</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前请求的文件路径，基于 root 或 <span class="built_in">alias</span> 和请求 URI</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_filename</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由16个随机字节生成的惟一请求标识符，以十六进制表示</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_id</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求长度(包括请求行、头和请求体)</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_length</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求方法，如 GET 或 POST</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_method</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求处理时间，从客户端读取第一个字节以来的时间</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若请求 /foo?a=1&amp;b=2，则 request_uri=/foo?a=1&amp;b=2</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_uri</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如 http 或 https</span></span><br><span class="line"><span class="meta">$</span><span class="bash">scheme</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 任意响应报头字段，变量名的最后一部分是转换为小写的字段名，用下划线替换破折号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sent_http_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 响应结束时发送的任意字段，变量名的最后一部分是转换为小写的字段名，用下划线替换破折号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sent_trailer_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受请求的服务器的地址</span></span><br><span class="line"><span class="meta">$</span><span class="bash">server_addr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受请求的 server 名称</span></span><br><span class="line"><span class="meta">$</span><span class="bash">server_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受请求的 server 端口</span></span><br><span class="line"><span class="meta">$</span><span class="bash">server_port</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求协议，如 HTTP/1.0 或 HTTP/1.1 或 HTTP/2.0</span></span><br><span class="line"><span class="meta">$</span><span class="bash">server_protocol</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 响应状态</span></span><br><span class="line"><span class="meta">$</span><span class="bash">status</span></span><br><span class="line"><span class="meta">$</span><span class="bash">tcpinfo_rtt,<span class="variable">$tcpinfo_rttvar</span>,<span class="variable">$tcpinfo_snd_cwnd</span>,<span class="variable">$tcpinfo_rcv_space</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地时间ISO 8601标准格式</span></span><br><span class="line"><span class="meta">$</span><span class="bash">time_iso8601</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通用日志格式的本地时间</span></span><br><span class="line"><span class="meta">$</span><span class="bash">time_local</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若请求 /foo?a=1&amp;b=2，则 uri=/foo</span></span><br><span class="line"><span class="meta">$</span><span class="bash">uri</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户代理</span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_user_agent</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cookie</span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_cookie</span></span><br></pre></td></tr></table></figure><h1 id="Nginx的访问鉴权（设置登录账号密码）"><a href="#Nginx的访问鉴权（设置登录账号密码）" class="headerlink" title="Nginx的访问鉴权（设置登录账号密码）"></a>Nginx的访问鉴权（设置登录账号密码）</h1><h2 id="首先安装htpasswd和ngxin工具"><a href="#首先安装htpasswd和ngxin工具" class="headerlink" title="首先安装htpasswd和ngxin工具"></a>首先安装htpasswd和ngxin工具</h2><p>用htpasswd的工具在/etc/创建一个用户密码，我这里创建一个admin用户，密码也是admin</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ htpasswd -c .htpasswd <span class="keyword">admin</span></span><br><span class="line"><span class="built_in">New</span> <span class="keyword">password</span>: <span class="keyword">admin</span></span><br><span class="line">Re-<span class="keyword">type</span> <span class="built_in">new</span> <span class="keyword">password</span>: <span class="keyword">admin</span></span><br><span class="line">Adding <span class="keyword">password</span> <span class="keyword">for</span> <span class="keyword">user</span> <span class="keyword">admin</span></span><br></pre></td></tr></table></figure><h2 id="在ngxin的配置文件中添加配置，加入你之前访问的端口是30003"><a href="#在ngxin的配置文件中添加配置，加入你之前访问的端口是30003" class="headerlink" title="在ngxin的配置文件中添加配置，加入你之前访问的端口是30003"></a>在ngxin的配置文件中添加配置，加入你之前访问的端口是30003</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">0.0.0.0:40003</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://localhost:30003/;</span><br><span class="line">      <span class="attribute">auth_basic</span> <span class="string">"Prometheus"</span>;</span><br><span class="line">      <span class="attribute">auth_basic_user_file</span> <span class="string">".htpasswd"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="启动nginx采用如下地址访问你的30003服务"><a href="#启动nginx采用如下地址访问你的30003服务" class="headerlink" title="启动nginx采用如下地址访问你的30003服务"></a>启动nginx采用如下地址访问你的30003服务</h2><p>在浏览器输入<a href="http://nginx-ip:40003，提示你需要输入账号密码，输入之前的admin/admin则登录成功">http://nginx-ip:40003，提示你需要输入账号密码，输入之前的admin/admin则登录成功</a></p><p>也可以在后台进行curl -u admin <a href="http://localhost:40003进行测试访问">http://localhost:40003进行测试访问</a></p><h2 id="Nginx中proxy-pass的配置"><a href="#Nginx中proxy-pass的配置" class="headerlink" title="Nginx中proxy_pass的配置"></a>Nginx中proxy_pass的配置</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">location</span> <span class="title">/test</span>/</span><br><span class="line">&#123;</span><br><span class="line">Proxy_pass http://t6:<span class="number">8300</span>;   <span class="comment">#不到/</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">location</span> <span class="title">/test</span>/</span><br><span class="line">&#123;</span><br><span class="line">Proxy_pass http://t6:<span class="number">8300</span>/;  <span class="comment">#带/</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>上面两种配置，区别只在于proxy_pass转发的路径后是否带 “/”</p><p>针对情况1，如果访问url = <a href="http://server/test/test.jsp，则被nginx代理后，请求路径会便问http://proxy_pass/test/test.jsp，将test/" target="_blank" rel="noopener">http://server/test/test.jsp，则被nginx代理后，请求路径会便问http://proxy_pass/test/test.jsp，将test/</a> 作为根路径，请求test/路径下的资源</p><p>针对情况2，如果访问url = <a href="http://server/test/test.jsp，则被nginx代理后，请求路径会变为" target="_blank" rel="noopener">http://server/test/test.jsp，则被nginx代理后，请求路径会变为</a> <a href="http://proxy_pass/test.jsp，直接访问server的根资源" target="_blank" rel="noopener">http://proxy_pass/test.jsp，直接访问server的根资源</a></p><h1 id="Nginx的启停"><a href="#Nginx的启停" class="headerlink" title="Nginx的启停"></a>Nginx的启停</h1><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> usr/<span class="built_in">local</span>/sbin</span><br><span class="line">./nginx</span><br></pre></td></tr></table></figure><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><p>更改配置重启nginx</p><p>kill -HUP 主进程号或进程号文件路径,或者使用</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/usr/local/sbin</span></span><br><span class="line"><span class="string">./nginx</span> -s <span class="keyword">reload</span></span><br></pre></td></tr></table></figure><p>判断配置文件是否正确　</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -t -c /usr/<span class="keyword">local</span>/<span class="keyword">conf</span>/nginx.<span class="keyword">conf</span></span><br><span class="line">或者</span><br><span class="line"><span class="keyword">cd</span> /usr/<span class="keyword">local</span>/sbin</span><br><span class="line">./nginx -t</span><br></pre></td></tr></table></figure><h2 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h2><p>查询nginx主进程号</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> nginx</span><br></pre></td></tr></table></figure><p>从容停止 kill -QUIT 主进程号<br>快速停止 kill -TERM 主进程号<br>强制停止 kill -9 nginx</p><p>若nginx.conf配置了pid文件路径，如果没有，则在logs目录下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -信号类型 <span class="string">'/usr/local/logs/nginx.pid'</span></span><br></pre></td></tr></table></figure><h1 id="Nginx如何读取环境变量"><a href="#Nginx如何读取环境变量" class="headerlink" title="Nginx如何读取环境变量"></a>Nginx如何读取环境变量</h1><h2 id="首先需要引入nginx的lua模块"><a href="#首先需要引入nginx的lua模块" class="headerlink" title="首先需要引入nginx的lua模块"></a>首先需要引入nginx的lua模块</h2><p>具体安装lua模块参考下列dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Base images 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> centos:centos7</span><br><span class="line"><span class="comment">#FROM hub.c.163.com/netease_comb/centos:7</span></span><br><span class="line"><span class="comment">#安装相关依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install  gcc gcc-c++ autoconf automake make</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install  zlib zlib-devel openssl* pcre* wget lua-devel</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#MAINTAINER 维护者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> niewx <span class="number">35715270</span>@qq.com</span><br><span class="line"> </span><br><span class="line"><span class="comment">#ADD  获取url中的文件,放在当前目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> http://nginx.org/download/nginx-1.14.0.tar.gz /tmp/</span></span><br><span class="line"><span class="comment">#LuaJIT 2.1</span></span><br><span class="line"><span class="comment">#ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz /tmp/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> https://github.com/LuaJIT/LuaJIT/archive/v2.0.5.tar.gz /tmp/</span></span><br><span class="line"><span class="comment">#ngx_devel_kit（NDK）模块</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz /tmp/</span></span><br><span class="line"><span class="comment">#lua-nginx-module 模块</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz /tmp/</span></span><br><span class="line"><span class="comment">#nginx ngx_cache_purge模块</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz  /tmp/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#切换目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">  /tmp </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装LuaJIT 2.0.5</span></span><br><span class="line"><span class="comment">#RUN wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz -P /tmp/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar zxf v2.0.5.tar.gz</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">  /tmp/LuaJIT-2.0.5</span></span><br><span class="line"><span class="comment">#RUN cd LuaJIT-2.0.5</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make PREFIX=/usr/<span class="built_in">local</span>/luajit </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make install PREFIX=/usr/<span class="built_in">local</span>/luajit</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装ngx_devel_kit(NDK)</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">  /tmp</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -xzvf v0.3.0.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cp -r ngx_devel_kit-0.3.0/ /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装lua-nginx-module模块</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -xzvf v0.10.13.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cp -r lua-nginx-module-0.10.13/ /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装nginx ngx_cache_purge模块</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -xzvf ngx_cache_purge-2.3.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cp -r ngx_cache_purge-2.3/ /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#设置环境变量</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p &#123;/usr/<span class="built_in">local</span>/logs,/var/lock&#125;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#编译安装Nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> useradd -M -s /sbin/nologin nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> tar -zxvf nginx-1.14.0.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /usr/<span class="built_in">local</span>/nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /tmp/nginx-1.14.0 \</span></span><br><span class="line"><span class="bash">	&amp;&amp; ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --user=nginx --group=nginx \</span></span><br><span class="line"><span class="bash">	--error-log-path=/usr/<span class="built_in">local</span>/logs/error.log \</span></span><br><span class="line"><span class="bash">	--http-log-path=/usr/<span class="built_in">local</span>/logs/access.log \</span></span><br><span class="line"><span class="bash">	--pid-path=/usr/<span class="built_in">local</span>/logs/nginx.pid \</span></span><br><span class="line"><span class="bash">	--lock-path=/var/lock/nginx.lock \</span></span><br><span class="line"><span class="bash">	--with-ld-opt=<span class="string">"-Wl,-rpath,/usr/local/luajit/lib"</span> \</span></span><br><span class="line"><span class="bash">	--with-http_stub_status_module \</span></span><br><span class="line"><span class="bash">	--with-http_ssl_module \</span></span><br><span class="line"><span class="bash">	--with-http_sub_module \</span></span><br><span class="line"><span class="bash">	--add-module=/usr/<span class="built_in">local</span>/src/lua-nginx-module-0.10.13 \</span></span><br><span class="line"><span class="bash">	--add-module=/usr/<span class="built_in">local</span>/src/ngx_devel_kit-0.3.0 \</span></span><br><span class="line"><span class="bash">	--add-module=/usr/<span class="built_in">local</span>/src/ngx_cache_purge-2.3 \</span></span><br><span class="line"><span class="bash">	&amp;&amp; make &amp;&amp; make install</span></span><br><span class="line"><span class="comment">#参数说明</span></span><br><span class="line"><span class="comment">#--prefix 用于指定nginx编译后的安装目录</span></span><br><span class="line"><span class="comment">#--add-module 为添加的第三方模块，此次添加了fdfs的nginx模块</span></span><br><span class="line"><span class="comment">#--with..._module 表示启用的nginx模块，如此处启用了http_ssl_module模块	</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/nginx -c /usr/<span class="built_in">local</span>/conf/nginx.conf</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/sbin/* /usr/<span class="built_in">local</span>/sbin/</span></span><br><span class="line"><span class="comment">#EXPOSE 映射端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">443</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#CMD 运行以下命令</span></span><br><span class="line"><span class="comment">#CMD ["nginx"]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/local/sbin/nginx"</span>,<span class="string">"-g"</span>,<span class="string">"daemon off;"</span>]</span></span><br></pre></td></tr></table></figure><h2 id="在系统中写入你的环境变量"><a href="#在系统中写入你的环境变量" class="headerlink" title="在系统中写入你的环境变量"></a>在系统中写入你的环境变量</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">TEST_IP</span>=10.10.10.10</span><br></pre></td></tr></table></figure><h2 id="在nginx中引入你的环境变量，具体编写参考如下"><a href="#在nginx中引入你的环境变量，具体编写参考如下" class="headerlink" title="在nginx中引入你的环境变量，具体编写参考如下"></a>在nginx中引入你的环境变量，具体编写参考如下</h2><p><img src="1.png" alt="upload-image"></p><h1 id="Nginx监听多个端口"><a href="#Nginx监听多个端口" class="headerlink" title="Nginx监听多个端口"></a>Nginx监听多个端口</h1><p>可以配置多个server，每个server配置不同的端口</p><p><img src="1.png" alt="upload-image"></p><h1 id="Nginx的负载均衡"><a href="#Nginx的负载均衡" class="headerlink" title="Nginx的负载均衡"></a>Nginx的负载均衡</h1><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//举例，以下IP，端口无效</span></span><br><span class="line"> upstream test&#123; </span><br><span class="line">      server <span class="number">11.22</span><span class="number">.333</span><span class="number">.11</span>:<span class="number">6666</span> weight=<span class="number">1</span>; </span><br><span class="line">      server <span class="number">11.22</span><span class="number">.333</span><span class="number">.22</span>:<span class="number">8888</span> down; </span><br><span class="line">      server <span class="number">11.22</span><span class="number">.333</span><span class="number">.33</span>:<span class="number">8888</span> backup;</span><br><span class="line">      server <span class="number">11.22</span><span class="number">.333</span><span class="number">.44</span>:<span class="number">5555</span> weight=<span class="number">2</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>down 表示单前的server临时不參与负载.</li><li>weight 默觉得1.weight越大，负载的权重就越大</li><li>backup： 其他全部的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻</li></ul><hr><ul class="pager"><li class="previous"><a href="/2021/06/12/use-operator-to-quickly-deploy-es-cluster-in-k8s/" data-toggle="tooltip" data-placement="top" title="使用eck快速在k8s部署es集群">&larr; Previous Post</a></li><li class="next"><a href="/2021/04/21/gitbook-generation-and-deployment-/" data-toggle="tooltip" data-placement="top" title="gitbook的生成和部署">Next Post &rarr;</a></li></ul><div class="comment_notes_blank"></div><div class="visitor_notice"><img src="/img/notice.png" alt="notice" title="notice"><p class="notice">欢迎访问 <a href="https://www.niewx.cn" target="Vashon">Vashon</a> 的博客，博客和文章在完善中，请大家耐心等待。 若有问题或者有好的建议欢迎留言，笔者看到之后会及时回复。 评论点赞需要github账号登录，如果没有账号的话请点击 <a href="https://github.com" target="view_window">github </a>注册， 谢谢 !</p></div><div class="comment_notes"><p></p></div><link rel="stylesheet" href="../../../../css/music-player/fonts/iconfont.css"><link rel="stylesheet" href="../../../../css/music-player/css/reset.css"><link rel="stylesheet" href="../../../../css/music-player/css/player.css"><div class="music-player"><audio class="music-player__audio"></audio><div class="music-player__main"><div class="music-player__blur"></div><div class="music-player__disc"><div class="music-player__image"><img width="100%" src="" alt=""></div><div class="music-player__pointer"><img width="100%" src="/img/cd_tou.png" alt=""></div></div><div class="music-player__controls"><div class="music__info"><h3 class="music__info--title">...</h3><p class="music__info--singer">...</p></div><div class="player-control"><div class="player-control__content"><div class="player-control__btns"><div class="player-control__btn player-control__btn--prev"><i class="iconfont icon-prev"></i></div><div class="player-control__btn player-control__btn--play"><i class="iconfont icon-play"></i></div><div class="player-control__btn player-control__btn--next"><i class="iconfont icon-next"></i></div><div class="player-control__btn player-control__btn--mode"><i class="iconfont icon-loop"></i></div></div><div class="player-control__volume"><div class="control__volume--icon player-control__btn"><i class="iconfont icon-volume"></i></div><div class="control__volume--progress player_progress"></div></div></div><div class="player-control__content"><div class="player__song--progress player_progress"></div><div class="player__song--timeProgess nowTime">00:00</div><div class="player__song--timeProgess totalTime">00:00</div></div></div></div></div></div><script src="../../../../js/music-player/utill.js"></script><script src="../../../../js/music-player/jquery.min.js"></script><script src="../../../../js/music-player/player.js?library=netease&music=https://kg.qq.com/node/play?s=7deFpz7Z26Jmv7di&g_f=share_html"></script><div class="social-share" data-wechat-qrcode-helper="" align="center"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script><hr><div id="blog_comments"></div><script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"><script>const myTheme={render(e,n){const t=document.createElement("div");return t.lang="en-US",t.className="gitment-container gitment-root-container",t.appendChild(n.renderSomething(e,n)),t.appendChild(n.renderHeader(e,n)),t.appendChild(n.renderComments(e,n)),t.appendChild(n.renderEditor(e,n)),t},renderSomething(e,n){const t=document.createElement("div");return t.lang="en-US",t.className="hello_visitor",e.user.login&&(t.innerText=`Hello ${e.user.login}, Welcome to comment system`),t}},gitment=new Gitment({id:"Fri May 21 2021 14:10:00 GMT+0800",owner:"nieweixing",repo:"gitalk-comment",oauth:{client_id:"26da2417eaf2810e1a39",client_secret:"ae5b1884fb67a1f9b8494dbe073eb62930a8bd9a"},theme:myTheme});gitment.render("blog_comments")</script></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx-conf配置文件解析"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Nginx.conf配置文件解析</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx在dockerfile中的配置"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Nginx在dockerfile中的配置</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx在配置文件中的内置变量"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Nginx在配置文件中的内置变量</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx的访问鉴权（设置登录账号密码）"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Nginx的访问鉴权（设置登录账号密码）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#首先安装htpasswd和ngxin工具"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">首先安装htpasswd和ngxin工具</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#在ngxin的配置文件中添加配置，加入你之前访问的端口是30003"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">在ngxin的配置文件中添加配置，加入你之前访问的端口是30003</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#启动nginx采用如下地址访问你的30003服务"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">启动nginx采用如下地址访问你的30003服务</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Nginx中proxy-pass的配置"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">Nginx中proxy_pass的配置</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx的启停"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">Nginx的启停</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#启动"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">启动</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#重启"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">重启</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#关闭"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">关闭</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx如何读取环境变量"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">Nginx如何读取环境变量</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#首先需要引入nginx的lua模块"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">首先需要引入nginx的lua模块</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#在系统中写入你的环境变量"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">在系统中写入你的环境变量</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#在nginx中引入你的环境变量，具体编写参考如下"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">在nginx中引入你的环境变量，具体编写参考如下</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx监听多个端口"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">Nginx监听多个端口</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Nginx的负载均衡"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">Nginx的负载均衡</span></a></li></ol></div></aside><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/#Nginx" title="Nginx">Nginx</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="https://cloud.tencent.com/developer/column/87421" target="_blank">云+社区</a></li><li><a href="https://www.niewx.cn/mybook/" target="_blank">gitbook</a></li><li><a href="https://github.com/nieweixing" target="_blank">vashon&#39;s Github</a></li><li><a href="https://weibo.com/3264907804/profile?rig" target="_blank">weibo</a></li></ul></div></div></div></article><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style type="text/css">@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://twitter.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.facebook.com/nieweixing"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/ke-wang-mian-bao-de-you-xia"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 聂伟星 2021<br>Powered by <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener"><i>hexo-theme-snail</i> </a>|<iframe name="star" style="margin-left:2px;margin-bottom:-5px" frameborder="0" scrolling="0" width="100px" height="20px" src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true"></iframe></p></div></div></div></footer><script src="../../../../js/jquery.min.js"></script><script src="../../../../js/bootstrap.min.js"></script><script src="../../../../js/hux-blog.min.js"></script><script src="../../../../js/search.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>0!==$("#tag_cloud").length&&async("https://www.niewx.cn/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="bfe4709ccd8c5c9e559c89f4fd0866f3",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><script type="text/javascript">var search_path="search.xml",path="/"+(search_path=0==search_path.length?"search.xml":search_path);searchFunc(path,"local-search-input","local-search-result")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><a id="rocket" href="#top" class=""></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/mouse-click.js" content="[&quot;🌱&quot;,&quot;just do it&quot;,&quot;🍀&quot;]" color="[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]"></script><script src="/js/ribbonDynamic.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!0},react:{opacity:.7}})</script></body></html>